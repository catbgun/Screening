---
title: "Screening2022_First test"
output: html_document
date: "2023-09-11"
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Functions* 
The following function will replace all "<LOD"
- har det no Ã¥ si om det er mellomrm mellom < og tallet? nei, tror ikke det
```{r}
#function to recognize "<LOD" and to replace with 0.5*LOD. The next step is to use this only for combinations of sample type and site with LOD >30
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for substitution
  as.numeric(v)
}

#Test to set desired number of digits
sigfig <- function(vec, digits){
  return(gsub("\\.$", "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
}
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "tidyr", "egg", "reshape2", "forcats")
lapply(Packages, library, character.only = TRUE)
#trengs disse? "Rmisc", "tidyverse", "lubridate", "stringr",
```

02.07.2024: manual editing of excel-txt file prior to upload.
- removed rows and columns not needed or empty
- replace comma with dot
- removed 45 i in the data. porrible interferences (NILU will check)
- need to sort out how to keep info with groupings
- Make sure that the short name of the molecules is at the bottom
Should be no zero values

12.08.2024
- new updated file used
- metadata hval og hai lagt til
- hvordan behandle "n.a"?
- hvordan behandle "detektert"?
- noen hadde mellomrom mellom < og nummer, fjernet i excel
- KAN IKKE HA BINDESTREK I COMPOUND-NAME)
- decomposes: TIPSIMA	TIPSIA
16.08.2024
- la til manglende metadata hval + info om pakke (ny kolonne!)

```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO")
df23 <- read.table("240816_240528_SCRE2023_Resultater.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))
```

```{r from wide to long}
df23_long <- gather(df23, compound, value, AOZKF:Fett, factor_key=TRUE)
df23_longg <- subset(df23_long, !is.na(value)) #usikker om denne tar bort alle versjoner av na

#compound BSAN removed since only NAs
#UV320 both NIVA and NILU
```

## Grouping the data
- by part 1 and 2
- by susbtance group
- and by groups of sampling sites/samples
- by sample type?

```{r Groupings}
gr23 <- read.table("Scre23_Groupings2.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))

#count substances per group
gr23x <- gr23 %>%
  group_by(Group) %>%
  mutate(unique_types = n_distinct(ID))

newtable <- merge(df23_longg, gr23, by.x  = "compound", by.y="ID") 

#to check if all are included. can be issues with names. "TIPSIMA" "TIPSIA" decomposed. 
setdiff(df23_long$compound,gr23$ID)
setdiff(df23_long$compound,newtable$compound)

newtable$compound <- revalue(newtable$compound, c("AG"="Ag", "AS"="As", "CD"="Cd", "CR"="Cr", "CU"="Cu", "FE"="Fe", "HG"="Hg", "NI"="Ni", "PB"="Pb", "SB"="Sb", "SE"="Se", "SN"="Sn", "ZN"="Zn"))
```

need to make column with frequency and then summary table.
will not rely in NA, but need to define >LOD.
Rather calculate mean later, after LOD has been replaced
```{r Detection frequency}
#Checking:
part1 <- subset(newtable, Part == "Part1")
part2 <- subset(newtable, Part == "Part2")

#New column in part2 to separate based on level of predator
part2$Category <- revalue(part2$Category, c("H???brann" = "Porbeagle shark", "Piggh???" = "Spiny dogfish", "sperm whale" = "Sperm whale", "H???kjerring"="Greenland shark"))

part2x = part2%>%
  mutate(Level = case_when(Category %in% c("Killer whale","Sperm whale", "Harbor porpoise", "White beaked dolphin") ~ "Whale top predator",
                           Category %in% c("Greenland shark", "Porbeagle shark") ~ "Shark top predator",
                                Category %in% c("Humpback whale", "Fin whale") ~ "Whale intermediate predator",
                           Category %in% c("Spiny dogfish") ~ "Shark intermediate predator"))
```

```{r Detection frequency}
#remove n.a due to limited sample material. SHould not be included in calculations
part1x <- subset(part1, value != "n.a.")

part1_freq = part1x %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), 
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

#For part 2, use Level instead of category
part2xx <- subset(part2x, value != "n.a.")

part2_freq = part2xx %>%
  group_by(Level, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), #her må det også legges inn "n.a."!!
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 
```

Filter out observations with < 30 detection frequency
#perhaps this one was better? START EHR!!! NOE SOM IKKE STEMMER
```{r Avoid plotting average of those with only < LOD}
part1_filt <- part1_freq %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD 
part1_filt_X <- cbind(part1_filt[,c(1:43)], apply(part1_filt[,44, drop=F],2, dLimity))


part2_filt <- part2_freq %>% 
  mutate(plotting = ifelse(det_frac ==0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD for those with detection frequency above 30%
part2_filt_X <- cbind(part2_filt[,c(1:44)], apply(part2_filt[,45, drop=F],2, dLimity))
```

Calculate mean
- sjekk at ble riktig! ta ut excel f eks
```{r}
part1_finalx = part1_filt_X %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#use either level or category
part2_finalx = part2_filt_X %>%
  group_by(Level, compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()
```

##geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 2))), color = "white", size = 5)+
#geom_text(aes(label=ifelse(is.na(meanx), "", round(meanx, digits=3))), color = "white", size = 5)

Set order of substances in plot
```{r}
part1_finalx$compound <- as.character(part1_finalx$compound)
part1_finalx$Group <- as.character(part1_finalx$Group)

part2_finalx$compound <- as.character(part2_finalx$compound)
part2_finalx$Group <- as.character(part2_finalx$Group)
part2_finalx$Sex <- as.character(part2_finalx$Sex)
part2_finalx$Maturity <- as.character(part2_finalx$Maturity)
part2_finalx$Packaging <- as.character(part2_finalx$Packaging)
```

##Part 1
```{r}
#to get "s" for suspect and "n.a." for not available
part1_finalxy <- part1_finalx %>% 
  mutate(meanxyz = ifelse(compound == "BHPMEBD" |compound == "DMPTDPP" | compound =="DMPTTPP", 
                           "S", 
                           " "))

#Rename names e.g. starting with a number
unique(part1_finalxy$compound)

part1_finalxy$compound <- revalue(part1_finalxy$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF" )) #er den siste riktig?

part1_finalxyz <- subset(part1_finalxy, compound!="Fett")
```

### Wastewater treatment plant
```{r Part1 Wastewater treatment pretreatment}
#subset
wwt <- subset(part1_finalxyz, Category == "Wastewater treatment")

#better names for sample types
unique(wwt$Sample.type)

wwt$Sample.type <- revalue(wwt$Sample.type, c("Water. filtered" = "Water, filtered (ng/L)", "Water. particulate" = "Water, particulate (ng/g, d.w.)", "Sludge" ="Sludge (ng/g, d.w.)", "Sediment" ="Marine sediment (ng/g, d.w.)", "Blue mussel" ="Blue mussel (ng/g, w.w.)"))

#set order of dample types
wwt2 <- wwt %>% 
  mutate(Sample.type = factor(Sample.type, levels = c("Water, filtered (ng/L)", "Water, particulate (ng/g, d.w.)", "Sludge (ng/g, d.w.)", "Marine sediment (ng/g, d.w.)", "Blue mussel (ng/g, w.w.)")))

```

BSAN (CAS 1678-25-7) n.a. due to limited sample material? <- na på alle så trenger ikke plotte?
Bisphenol, BHPMEBD (CAS 147504-92-5) suspect screaming only (not relevant for Part 2). 
Triazines, DMPTDPP (CAS 178905-31-2) and DMPTTPP (CAS 178905-32-3) suspect screening only. 
```{r WWTP samples}
wwt_long2 <- ggplot(wwt3, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0)) +
  ggtitle("Wastewater treatment plant (scre23)") + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))

#theme(strip.text.y = element_text(angle = 0),
 #           legend.position = "none")

ggsave("WW_t2.png", wwt_long2, width = 10, height = 18)

```

### HOTSPOTS (known and unknown)
- dust was separated to private home and commercial manually in excel, if needed
```{r Part1 HOTSPOTS}
#subset
hotspot <- subset(part1_finalxyz, Category == c("Known hotspot", "Unknown hotspot"))

unique(hotspot$Sample.type)
#separate dust from homes and commercial
#hotspot$Sample.type[(hotspot$Sample.type == "Dust_private") & (hotspot$Treatmen == "Private home")] <- #"Private home, dust (ng/g, d.w.)"
#hotspot$Sample.type[(hotspot$Sample.type == "Dust_recycling") & (hotspot$X == "Commercial building")] <- "Waste recycling, dust (ng/g, d.w.)"

#better names for sample types
hotspot$Sample.type <- revalue(hotspot$Sample.type, c("Soil" = "Agricultural soils (ng/g, d.w.)", "Product" ="Commercial products (ng/g)", "Dust" = "Indoor dust (ng/g, d.w.)"))

#set the order
hotspot1 <- hotspot %>% 
  mutate(Sample.type = factor(Sample.type, levels = c("Indoor dust (ng/g, d.w.)", "Commercial products (ng/g)", "Agricultural soils (ng/g, d.w.)")))


#known and unknown hotspots together
  
HS_t <- ggplot(hotspot1, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
    geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
    theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0)) +
  ggtitle("Hotspots (known and unknown") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))

ggsave("HS_t.png", HS_t, width = 10, height = 18)
```


## Part 2
### Screening substances
SVOC, semi-quantified: Sus62 (CAS 54464-54-9), SYLKL (CAS 676532-44-8), SEROLD (477218-42-1), DIUDP (96507-80-1), EMOPCC (CAS 59151-19-8), CTCVB (CAS 4714-35-6), DCTCVB (CAS  88218-49-9), TCTDT (CAS 2149571-40-2), ETTSDD (CAS 38233-76-0), MPSHDOSD (CAS 125962-78-9), HOTMIKA (CAS 93777-71-0).
HCBD (CAS 87-68-3) not available due to limited sample material. 

OPFR metabolites (n=7) not available for all samples due to limited sample material. 
- whales and sharks
```{r Urban fjord preparation - Part 2}
#REVALUE
part2_finalx$Sample.type <- revalue(part2_finalx$Sample.type, c("Blubber" ="Blubber (ng/g, w.w.)", "Liver" = "Liver (ng/g, w.w.)", "Muscle"="Muscle (ng/g, w.w.)"))

part2_finalxc <- subset(part2_finalx, compound !="Fett")

part2_finalxc$compound <- revalue(part2_finalxc$compound, c("BENAZOL.P"="BENAZOL P", "X2BBTMP"="2BBTMP",  "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X2TBCLBEP"="2TBCLBEP",
                                                            "X42FTS"="42FTS", "X62FTS"="62FTS", "X82FTS"="82FTS", "X102FTS"="102FTS", "X122FTS"="122FTS", "X2BDMP"="2BDMP"))
```

```{r Part2 scre23}
#SUBSET
part2_finalxy23 <- subset(part2_finalxc, Extra == "Scre23")

#SET THE ORDER IN PLOT
part2_finalxy23x <- part2_finalxy23 %>% 
  mutate(Level = factor(Level, levels = c("Whale top predator", "Whale intermediate predator", "Shark top predator", "Shark intermediate predator")))

#PLOTTING
ggplot(part2_finalxy23x, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 1.05),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=10)) +
  ggtitle("Whales and sharks (scre23)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

ggsave("WS_23.png", WS_23, width = 8, height = 17) 
```

### Extra(urban fjord) substances
- whales and sharks
```{r Part2 Extra}
part2_extra <- subset(part2_finalxc, Extra == "Extra")

part2_extra1 <- part2_extra %>% 
  mutate(Level = factor(Level, levels = c("Whale top predator", "Whale intermediate predator", "Shark top predator", "Shark intermediate predator")))

#sh <- subset(part2_UF_1, Level =="Whale top predator"& compound=="LCCP")
#sd <- subset(part2_extra1, Level =="Whale top predator"& compound=="LCCP")

part2_UF_1 <- subset(part2_extra1, Group %in% c("CP", "Dechlorane", "nBFR", "OPFR", "OPFR_metabolite"))
part2_UF_2 <- subset(part2_extra1, Group %in% c("nPFAS", "PBDE", "PCB"))
part2_UF_3 <- subset(part2_extra1, Group %in%c("PFCA", "PFSA", "QNH4", "UV") | compound=="Hg")

UF1 <-ggplot(part2_UF_1, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91") +# determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 1.05),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=9), 
        strip.text.y = element_text(angle = 0, size=10)) +
  ggtitle("Whales and sharks (urban fjord 1/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

UF2 <- ggplot(part2_UF_2, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 1.05),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=9), 
        strip.text.y = element_text(angle = 0, size=10)) +
  ggtitle("Whales and sharks (urban fjord 2/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

UF3 <- ggplot(part2_UF_3, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 1.05),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=9), 
        strip.text.y = element_text(angle = 0, size=10)) +
  ggtitle("Whales and sharks (urban fjord 3/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

#save
ggsave("Part1_UF1.png", UF1, width = 8, height = 10)
ggsave("Part1_UF2.png", UF2, width = 8, height = 12)
ggsave("Part1_UF3.png", UF3, width = 8, height = 10)

```

# Exploring site specific contamination patterns
- if using average values, need to make sure that the averages are calculated correctly based on grouping
- do we caare about the detection frequency here? and how to deal with < LOD?
- here we can include all data and only do the average, not the >30% detection (?)

1) Waste water treatment
- are thre differences between high and low treatment? water and solids
- are there differences between time points of sampling?

a) wastewater treatment high and low, and with recipient below 
```{r Wastewater treatment high and low}
#gjennomsnitt på skille på purification degree
#"n.a." already removed

#We only need water filtered, water particles, and sludge
part1xx <- subset(part1x, Matrix == c("Wastewater treated"))

part1_freq_ww = part1xx %>%
  group_by(compound, Sample.type, Treatmen) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part1_filt_ww <- part1_freq_ww %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "<LOD", 
                           value))

part1_filt_ww1 <- cbind(part1_filt_ww[,c(1:42)], apply(part1_filt_ww[,43, drop=F],2, dLimity))

part1_final_ww2 = part1_filt_ww1 %>%
  group_by(Category, compound, Sample.type, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part1_final_ww2$compound <- as.character(part1_final_ww2$compound)
part1_final_ww2$Group <- as.character(part1_final_ww2$Group)

#rename
part1_final_ww2$Sample.type <- revalue(part1_final_ww2$Sample.type, c("Water. filtered" = "Water, filtered (ng/L)", "Water. particulate" = "Water, particulate (ng/g, d.w.)", "Sludge" ="Sludge (ng/g, d.w.)"))

#set order
part1_final_ww2$Sample.type <- factor(part1_final_ww2$Sample.type, levels=c("Water, filtered (ng/L)", "Water, particulate (ng/g, d.w.)", "Sludge (ng/g, d.w.)")) 
#Fjern alle < LOD
part1_final_ww3 <- subset(part1_final_ww2, meanx != "NaN") 

#remove the duplicated values, but value and plotting are different so must first be removed
part1_final_ww4 <- distinct(part1_final_ww3, meanx, Sample.type, compound, Treatmen, .keep_all= TRUE) 

#part1_final_ww3<- part1_final_ww2x[!duplicated(part1_final_ww2x), ]


WWT_treatment <-ggplot(part1_final_ww4, aes(y=log(meanx), x=compound, fill=Treatmen))+
  #geom_col(position = position_dodge2(preserve = "single")) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_col(position="dodge", width = 0.5)+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Sample.type~Group, scales="free", space='free_x')

ggsave("WWT_treatment.png", WWT_treatment, width = 10, height = 9)
```

b) indoor dust - private homes and recycling facility
```{r Dust private and recycling}
# skille på purification degree
dust <- subset(part1x, Sample.type == "Dust")

dust1 = dust %>%
  group_by(Treatmen, compound) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

dust2 <- dust1 %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "< LOD", 
                           value))

dust3 <- cbind(dust2[,c(1:42)], apply(dust2[,43, drop=F],2, dLimity))

dust4 = dust3 %>%
  group_by(compound, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#part1_final_duy <- subset(part1_final_du, det_frac > 30)
#part1_final_duyz <- subset(part1_final_duy, compound != "Fett")
dust4$compound <- as.character(dust4$compound)
dust4$Group <- as.character(dust4$Group)
dust4$Treatmen <- as.character(dust4$Treatmen)

#rename
dust4$Treatmen <- revalue(dust4$Treatmen, c("Recycling facility"="Recycling facility, dust (ng/g, d.w.)", "Private home" = "Private homes, dust (ng/g, d.w.)"))

#set order (also for products used blow)
dust4$Treatmen <- factor(dust4$Treatmen, levels=c("Recycling facility, dust (ng/g, d.w.)", "Private homes, dust (ng/g, d.w.)")) 

#Fjern alle < LOD
dust5 <- subset(dust4, meanx != "NaN") 

dust <- ggplot(dust5, aes(y=log(meanx), x=compound, fill=Treatmen))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=13, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="none")+
  facet_grid(Treatmen~Group, scales="free_x", space='free_x')

ggsave("DUST.png", dust, width = 10, height = 8)

#  legend.position = "none"
```

c)
```{r Products}
prod <- subset(part1x, Sample.type=="Product")

prod1 = prod %>%
  group_by(Treatmen, compound) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

prod2 <- prod1 %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "< LOD", 
                           value))

prod3 <- cbind(prod2[,c(1:42)], apply(prod2[,43, drop=F],2, dLimity))

prod4 = prod3 %>%
  group_by(compound, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#part1_final_duy <- subset(part1_final_du, det_frac > 30)
#part1_final_duyz <- subset(part1_final_duy, compound != "Fett")
prod4$compound <- as.character(prod4$compound)
prod4$Group <- as.character(prod4$Group)
prod4$Treatmen <- as.character(prod4$Treatmen)

#Fjern alle < LOD
prod5 <- subset(prod4, meanx != "NaN") 

products <- ggplot(prod5, aes(y=log(meanx)+10, x=compound, fill=Treatmen))+
  #geom_col(position="dodge")+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(.~Group, scales="free", space='free_x')+
  scale_fill_discrete(name = "Product type")+
  ylab("log(ng/L, d.w.)+10")

ggsave("PRODUCTS.png", products, width = 10, height = 5)

```

- agricultural soils? Need to separate the different types in the file. 

d) WHALES AND SHARKS
- need to new averages, not based on level but on category (+ sample type and compound)
```{r}
#allerede fjernet er "n.a."
part2_freq_2 = part2xx %>%
  group_by(Group, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), 
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part2_filt_2 <- part2_freq_2 %>% 
  mutate(plotting = ifelse(det_frac ==0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD for those with detection frequency above 30%
part2_filt_X_2 <- cbind(part2_filt_2[,c(1:44)], apply(part2_filt_2[,45, drop=F],2, dLimity))

#Category - for part 2 of report
part2_final_2 = part2_filt_X_2 %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part2_final_2$compound <- as.character(part2_final_2$compound)
part2_final_2$Group <- as.character(part2_final_2$Group)
part2_final_2$Sex <- as.character(part2_final_2$Sex)
part2_final_2$Maturity <- as.character(part2_final_2$Maturity)
part2_final_2$Packaging <- as.character(part2_final_2$Packaging)

```

- looking at the top preds
```{r top predators}
topP <- subset(part2_final_2, Level=c("Whale top predator", "Shark top predator"))
topP2 <- subset(topP, meanx != "NaN") #only include those with average value and no suspect etc or < LOD.

print(unique(topP2$compound))
print(unique(topP2$Group))
print(unique(topP2$Category))

#compare whale blubber with shark top liver?
#unique(topP2$Sample.type)
topP3 <- subset(topP2, Sample.type =c("Blubber", "Liver"))
#topP3x <- subset(topP3, Level ==c("Whale top predator", "Shark top predator"))


#rename
topP3$Level <- revalue(topP3$Level, c("Shark intermediate predator" = "Shark intermediate pred. (liver)", "Shark top predator" = "Shark top pred. (liver)", "Whale intermediate predator" = "Whale intermediate pred. (blubber)", "Whale top predator"= "Whale top pred. (blubber)"))

#set order (also for products used blow)
topP3$Level <- factor(topP3$Level, levels=c("Whale top pred. (blubber)","Shark top pred. (liver)", "Whale intermediate pred. (blubber)", "Shark intermediate pred. (liver)")) 
topP4 <- subset(topP3, !compound %in% c("Fett", "Ag","As","Cd","Cr", "Cu","Fe","Ni","Pb","Sb","Se","Sn","Zn"))

#Looking at the four different groups together
whales <- ggplot(topP4, aes(x=compound, y=log(plotting)+10, colour=Level))+
  geom_point(size=2)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top")+
  facet_grid(.~Group, scales="free", space='free_x')+
  scale_colour_discrete(name = "Group")
  
ggsave("Whale groups.png", whales, width = 10, height = 7)

#Looking at the top whale group
topP3xx <- subset(topP4, Level ==c("Whale top pred. (blubber)"))

ggplot(topP3xx, aes(x=compound, y=(plotting), colour=Category))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()
  
  

```
- looking at the killer whales
```{r whales blubber}

#find back the metadata!!! and perhaps also the stable isotopes
KW <- subset(topP4, Category=="Killer whale")
blub <- subset(topP4, Sample.type=="Blubber")
whale <- subset(topP4, Treatmen=="Whales")
HP <- subset(topP4, Category=="Harbor porpoise"&Length==136)

KW$Maturity <- as.character(KW$Maturity)
unique(KW$Maturity)
part2_final_2$Group <- as.character(part2_final_2$Group)

blub$value <- as.numeric(blub$value)
whale$value <- as.numeric(whale$value)
HP$value <- as.numeric(HP$value)

HP$value <- as.numeric(HP$value)

ggplot(subset(HP, !is.na(value)), aes(x=compound,  y=log(value)+10, fill=Sample.type, colour=Sample.type))+
  geom_point(size=5, shape=15)+
  #geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Harbour porpoise)", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()
  
  ggplot(wbd, aes(x=compound, y=log(value),colour=Sample.type))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Whales (blubber)", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()

```

```{r sharks}
#find back the metadata!!! and perhaps also the stable isotopes
shark <- subset(topP4, Treatmen=="Sharks")
blub <- subset(topP4, Sample.type=="Blubber")

KW$Maturity <- as.character(KW$Maturity)
unique(KW$Maturity)
part2_final_2$Group <- as.character(part2_final_2$Group)

shark$value <- as.numeric(shark$value)

#New column in part2 to separate based on level of predator

ggplot(shark, aes(x=compound, y=log(value), colour=Category, shape=Sample.type))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Sharks", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()
```

```{r Packaging}

topP4$value <- as.numeric(topP4$value)
ggplot(topP4, aes(x=compound, y=log(value), colour=Packaging))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Packaging material (whales and sharks)", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()
```

Se på stabil isotop
```{r}
topP4$Delta.13C <- as.numeric(topP4$Delta.13C)

ggplot(subset(topP4, !is.na(Delta.15N)), aes(x=Category, y=W..C.N))+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Packaging material (whales and sharks)", ylab="Concentration log(ng/g, w.w.)+10")
  facet_grid(Sample.type~., scales="free", space='free_x')
  geom_boxplot()

```




```{r sperm whale}
spermw <- subset(topP4, Category=="Sperm whale")

spermw$value <- as.numeric(spermw$value)
ggplot(spermw, aes(x=compound, y=log(value)+10, colour=Packaging))+
  geom_point(size=3)+
  #geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Packaging material (whales and sharks)", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')
  geom_boxplot()

```


```{r Harbor Porpoise - 3 different tissues}
HP <- subset(part2, Category =="Harbor porpoise")

HP1 = HP %>%
  group_by(compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

HP2 <- HP1 %>% 
  mutate(plotting = ifelse(det_frac <30, 
                           "low detection", 
                           value))

HP3 <- cbind(HP2[,c(1:23)], apply(HP2[,24, drop=F],2, dLimity))

HP4 = HP3 %>%
  group_by(compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

HP5 <- subset(HP4, det_frac > 30)
HP6 <- subset(HP5, compound != "Fett")
HP6$compound <- as.character(HP6$compound)
HP6$Group <- as.character(HP6$Group)

#SEPARATE
HP6met <- subset(HP6, Group = c("Metal", "PCB", "PBDE"))

HP6met <- subset(HP6, Group != "OPFR_metabolite")

ggplot(HP6met, aes(y=log(meanx)+5, x=compound, fill=Sample.type))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Sample.typ~Group, scales="free", space='free_x')
```

Part 2) Whales and sharks
- species
- tissue
- sex
- age
- fat
- isotopes

```{r Blubber by specie}
part2_freq_wb = part2 %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part2_filt_wb <- part2_freq_wb %>% 
  mutate(plotting = ifelse(det_frac <30, 
                           "low detection", 
                           value))

part2_filt_wbz <- cbind(part2_filt_wb[,c(1:23)], apply(part2_filt_wb[,24, drop=F],2, dLimity))

part2_final_wb = part2_filt_wbz %>%
  group_by(Category, compound, Sample.type, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part2_final_wby <- subset(part2_final_wb, det_frac > 30)
part2_final_wbyz <- subset(part2_final_wby, compound != "Fett")
part2_final_wbyz$compound <- as.character(part2_final_wbyz$compound)
part2_final_wbyz$Group <- as.character(part2_final_wbyz$Group)

#SEPARATE
part2_final_wbyz23 <- subset(part2_final_wbyz, Extra == "Extra")
part2_final_wbyz23met <- subset(part2_final_wbyz, Group == "Metal")
part2_final_wbyz23i <- subset(part2_final_wbyz, Extra == "Scre23")

#PLOTTING
ggplot(subset(part2_final_wbyz23, Sample.type%in% c("Blubber")), aes(y=log(meanx)+5, x=compound, fill=Treatmen))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Category~Group, scales="free", space='free_x')

```

```{r Muscle by specie}
part2_freq_wb = part2 %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part2_filt_wb <- part1_freq_wb %>% 
  mutate(plotting = ifelse(det_frac <30, 
                           "low detection", 
                           value))
part2_filt_wbz <- cbind(part2_filt_wb[,c(1:20)], apply(part2_filt_wb[,21, drop=F],2, dLimity))

part2_final_wb = part2_filt_wbz %>%
  group_by(Category, compound, Sample.type, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part2_final_wby <- subset(part2_final_wb, det_frac > 30)
part2_final_wbyz <- subset(part2_final_wby, compound != "Fett")
part2_final_wbyz$compound <- as.character(part2_final_wbyz$compound)
part2_final_wbyz$Group <- as.character(part2_final_wbyz$Group)

#SEPARATE
part2_final_wbyz23 <- subset(part2_final_wbyz, Extra == "Extra")
part2_final_wbyz23met <- subset(part2_final_wbyz, Group == "Metal")
part2_final_wbyz23 <- subset(part2_final_wbyz, Extra == "Scre23")
part2_final_wbyz23 <- subset(part2_final_wbyz, Group != "Metal")

#PLOTTING
ggplot(subset(part2_final_wbyz23, Sample.type%in% c("Muscle")), aes(y=(meanx), x=compound, fill=Treatmen))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Category~Group, scales="free", space='free_x')

```

```{r Killer whales}

killerw <- subset(part2, Category =="Killer whale")

part2_freq_wb = part2 %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part2_filt_wb <- part1_freq_wb %>% 
  mutate(plotting = ifelse(det_frac <30, 
                           "low detection", 
                           value))
part2_filt_wbz <- cbind(part2_filt_wb[,c(1:20)], apply(part2_filt_wb[,21, drop=F],2, dLimity))

part2_final_wb = part2_filt_wbz %>%
  group_by(Category, compound, Sample.type, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part2_final_wby <- subset(part2_final_wb, det_frac > 30)
part2_final_wbyz <- subset(part2_final_wby, compound != "Fett")
part2_final_wbyz$compound <- as.character(part2_final_wbyz$compound)
part2_final_wbyz$Group <- as.character(part2_final_wbyz$Group)

ggplot(subset(part2_final_wbyz23met, Category%in% c("Killer whale")), aes(y=(meanx), x=compound, fill=Treatmen))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Category~Group, scales="free", space='free_x')

```




Calculate mean
- sjekk at ble riktig! ta ut excel f eks

```{r}
#df_long_Y <- df_long_X[!is.na(df_long_X$value),]
#Site_Comment indicate seasonality
#Site_Comment22 indicate conditional differences like high and low purification

#write.csv(df_long_X, "C:/Users/CBG/OneDrive - NIVA/1 #Projects/Screening/Screening_R/Screening/Output/2310054_TEST_barcharts.csv", row.names=FALSE)

envixx1 = df_finalzzzzx %>%
  group_by(Site_Category, compound, Medium_id, Comment_season, Site_name) %>%
  mutate(meanx_season = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx2 = envixx1 %>%
  group_by(Site_Category, compound, Medium_id, Comment_condition) %>%
  mutate(meanx_cond = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx3 = envixx2 %>%
  group_by(Site_Category, compound, Medium_id, Site_name) %>%
  mutate(meanx_name = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx4 = envixx3 %>%
  group_by(Site_Category, compound, Medium_id, Site_Comment) %>%
  mutate(meanx_sc = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx5d = envixx4 %>%
  group_by(Site_Category, compound, Comment_location, Medium_id, Comment_condition) %>%
  mutate(meanx_sc2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx5 = envixx5d %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#for the tunnel we want to separate by Medium_id and by tunnel versus recipient pond
envixx6 <- envixx5 %>%
  mutate(tunnel_site = ifelse(Site_name == "Smestaddammen", "Receiving pond", "Tunnel"))

envixx7 = envixx6 %>%
  group_by(Site_Category, compound, Medium_id2, Comment_location) %>%
  mutate(meanx_tun = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#for road traffick and park, also for wastewater
envixx8 = envixx7 %>%
  group_by(Site_Category, compound, Medium_id, Comment_season) %>%
  mutate(meanx_air = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#tuyre recycling to combine filtered and total water
envixx9 = envixx8 %>%
  group_by(Site_Category, compound, Medium_id2) %>%
  mutate(meanx_tyr = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#Alns
envixx10 = envixx9 %>%
  group_by(Site_Category, compound, Medium_id, Site_name) %>%
  mutate(meanx_riv = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx11 = envixx10 %>%
  group_by(Site_Category, compound, Medium_id, Site_name, Comment_condition) %>%
  mutate(meanx_ri2v = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx12x = envixx11 %>%
  group_by(Site_Category, compound, Medium_id, Comment_location) %>%
  mutate(meanx_indo = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx12y = envixx12x %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(meanx_indo2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixxc = envixx12y %>%
  group_by(Site_Category, compound, Medium_id, Comment_location) %>%
  mutate(meanx_loc = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

```


1) Artificial grass pitch
- fix order of facets and size of text, grouping of molecules
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx))

envixx4$m_group <- revalue(envixx4$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

print(unique(envixx4$Medium_id))

#set order of facets
envixx4$Medium_id <- factor(envixx4$Medium_id, levels=c("Water, total (ng/L)", "Sludge (ng/g, d.w.)", "Air, particles (ng/m^3)","Granule (ng/g, w.w.)", "Sediment (ng/g, d.w.)", "Dust (ng/g, w.w.)","Water, filtered (ng/L)", "Water, particles (ng/L)", "Biota (ng/g, w.w.)", "Air (ng/m^3)" )) 

#testing grouping below x axis
foot <- ggplot(subset(envixx4, Site_Category%in% c("Artificial grass pitch")), aes(y=meanx, x=compound, fill=Medium_id))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue3", "dodgerblue3", "dodgerblue3", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Medium_id~m_group, scales="free", space='free_x')
 
ggsave("Football.png", foot)


  
```

2) Tunnel environment
- what ends up in the pond?
- difference between filtered and total water?
- differences during the washing?
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_tun))

envixx4$m_group <- revalue(envixx4$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

#the most interesting is what reaches the pond. Figure with discharge and pond

#envixx4x <- subset(envixx4, Medium_id  %in% c("Water (ng/L)", "Water, filtered (ng/L)"))
#envixx4x1 <- subset(envixx4x, Medium_id  %in% c("Sediment (g/g)", "Sludge (g/g)"))
#envixx4x1 <- subset(envixx4x, Medium_id  %in% c("Water (ng/L)"))

envixx4$Comment_location <- revalue(envixx4$Comment_location, c("Sedimentation pool"="Sedimentation basin"))
envixx4x1 <- subset(envixx4, Comment_location  %in% c("Recipient pond", "Sedimentation basin"))

envixx4x2 <- subset(envixx4x1, Medium_id2  %in% c("Solids"))

unique(envixx4x1$Comment_location)

tunn <- ggplot(subset(envixx4x1, Site_Category%in% c("Tunnel environment")), aes(y=meanx_tun, x=compound, fill= Comment_location))+
  geom_col(position="dodge")+
  facet_grid(Comment_location~., scales="free")+
  scale_fill_manual(values=c("dodgerblue3", "#E69F00"))+
  theme_bw()+
    theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Comment_location~m_group, scales="free", space='free_x')
  


ggsave("Tunnel.png", tunn, width = 7.86, height = 6)
```
3) Trafficked road and urban park
- difference between park and road
- difference between seasons
- difference between weekend and weekday
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_air))

envixx4x2 <- subset(envixx4, Medium_id  %in% c("Air, particles (ng/m^3)"))

#remove duplicate rows before plotting
envixx4x3 <-envixx4x2 %>% 
  distinct(meanx_air, compound, Site_Category, Comment_season, .keep_all = TRUE)

envixx4x3$m_group <- revalue(envixx4x3$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


road <- ggplot(subset(envixx4x3, Site_Category%in% c("Trafficked road", "Urban park")), aes(y=meanx_air, x=compound, fill=Site_Category))+
  geom_col(position = position_dodge2(preserve = "single"))+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Comment_season~m_group, scales="free", space='free_x')

ggsave("Road.png", road, width = 7.86, height = 6)

```

4) Wastewater treatment
- only focus on difference between high and low quality treatment
- seasonality ont so interesting, and espesially not with only two observations
To DO: rekkefølge medium, gruppering stoffene, etc. 
```{r differences in wastewater treatment}
#remove nas

envixx4cs <- subset(envixx2x, !is.na(meanx_cond))

envixx4cs$Comment_condition <- factor(envixx4cs$Comment_condition, levels=c("Low", "High" )) 
envixx4cs$Medium_id <- factor(envixx4cs$Medium_id, levels=c("Water, total (ng/L)", "Sludge (ng/g, d.w.)")) 

#pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")
envixx4css <- subset(envixx4cs, !Medium_id == c("Air (ng/^3)")) 

unique(envixx4$Medium_id)

envixx4css$m_group <- revalue(envixx4css$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


wwater <- ggplot(subset(envixx4css, Site_Category%in% c("Wastewater treatment plant")), aes(y=meanx_cond, x=compound, fill=Comment_condition))+
  geom_col(position="dodge")+
  facet_grid(Medium_id~., scales="free")+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=c("dodgerblue2", "dodgerblue4"))+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Medium_id~m_group, scales="free", space='free_x')

ggsave("Wwater.png", wwater, width = 7.86, height = 6.8)

```

5) Tyre collection site
- what goes into the environment?
- similar pattern as the rest?
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_tyr))

#envixx4x2 <- subset(envixx4, !Medium_id  %in% c("Sludge (ng/g)"))
envixx4x3 <- subset(envixx4, Medium_id  %in% c("Water, particles (ng/L)", "Water, filtered (ng/L)", "Dust (ng/g, w.w.)"))

nrow(envixx4x3)
nrow(envixx4)

labx <- c("Air" = "Dust (ng/g)",
          "Water" = "Water (ng/L)")

envixx4x3$m_group <- revalue(envixx4x3$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


tyre <- ggplot(subset(envixx4x3, Site_Category%in% c("Tyre collection site")), aes(y=meanx_tyr, x=compound))+
  geom_col(position="dodge", fill="dodgerblue3")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  labs(fill = "Site category")+
facet_grid(Medium_id2~m_group, scales="free", space='free_x', labeller = labeller(Medium_id2 =labx))

ggsave("Tyre.png", tyre, width = 7.86, height = 6.8)
```

6) Urban river Alna
- difference along the river
- difference between low and high flow
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_riv))

envixx4c$Site_name <- revalue(envixx4c$Site_name, c("Apall?kka"="Kalbakken"))
print(unique(envixx4c$Site_name))
 
envixx5c <- envixx4c %>% 
  mutate(Site_name = factor(Site_name, levels = c("Kalbakken", "Brubak", "Breivoll", "Kv'rner")))

envixx5c$Site_name <- revalue(envixx5c$Site_name, c("Kv'rner"="Kværner"))
envixx_AlnaS <- subset(envixx5c, Medium_id == "Sediment (ng/g, d.w.)")
envixx_AlnaW <- subset(envixx5c, Medium_id == "Water, total (ng/L)")

Alna <- ggplot(subset(envixx_AlnaW, Site_Category%in% c("Urban river")), aes(y=meanx_riv, x=compound, fill=Site_name))+
  geom_col(position="dodge")+
  facet_grid(Medium_id~Site_name, scales="free_y")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=11, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  scale_fill_manual(values=c("dodgerblue", "dodgerblue3", "dodgerblue4",  "darkblue"))+
  labs(fill = "Site category")+
facet_grid(Site_name~m_group, scales="free_x", space='free_x')

ggsave("Alna.png", Alna,  width= 6.86, height= 7.32)

```

7) Indoor air
- Difference between private and commercial?
- different between the commercial?
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_indo))
envixx4c2 <- subset(envixx2x, !is.na(meanx_indo2))

envixx_IndoA <- subset(envixx4c, Medium_id == "Air (ng/m^3)")
envixx_IndoD <- subset(envixx4c, Medium_id == "Dust (ng/g)")

envixx4c2$m_group <- revalue(envixx4c2$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

air <- ggplot(subset(envixx4c2, Site_Category%in% c("Private home", "Commercial building")), 
       aes(y=meanx_indo2, x=compound, fill=Site_Category))+
  geom_col(position="dodge")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Medium_id~m_group, scales="free", space='free_x')+
  scale_fill_manual(values=c("dodgerblue2", "dodgerblue4"))


ggsave("Air.png", air, width = 7.86, height = 6.8)

```

7) Biota
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_sc2))
length(envixx3)

#  facet_grid(Medium_id~Site_Comment, scales="free_y")+
#envixx4x <- subset(envixx4, Medium_id  %in% c("Granule (g/g)"))

envixx5cs <- envixx4c %>% 
  mutate(Comment_condition = factor(Comment_condition, levels = c("Duck mussel", "Perch liver and filet", "Cod liver", "Seagull egg", "Seal blubber")))

envixx5cs$m_group <- revalue(envixx5cs$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

biota <- ggplot(subset(envixx5cs, Site_Category%in% c("Recipient")), aes(y=meanx_sc2, x=compound, fill=Comment_condition))+
  geom_col(position="dodge")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Specie and tissue")+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4", "dodgerblue",  "dodgerblue3", "dodgerblue4"))+
  facet_grid(Comment_location~m_group, scales="free_x", space='free_x')

ggsave("Biota.png", biota, width = 7.86, height = 6.8)
```
















```{r}
library(dplyr)
#is the following correct?
df_filteredX = df_filtered %>%
  group_by(Site_Category, compound) %>%
  summarize(mean = mean(value, na.rm = TRUE),
            nacount = (sum(is.na(value))),
            detect_frac = ((sum(!is.na(value)))/((sum(!is.na(value)))+nacount)*100), 
            .groups="keep")

class(df_filteredX$mean)

```
















```{r making table}
#if(!require(devtools)) install.packages("devtools")
#devtools::install_github("cardiomoon/ztable")
library(ztable)
library(moonBook)

x=table(df_filtered$Dx,acs$smoking)
x

mycolor=gradientColor(low="yellow",mid="orange",high="red",n=6,plot=TRUE)

#subset only those needed
#from long to wide
data_wide <- spread(df_filtered, compound, value)
data_wide2 <-data_wide[,c(2,9, 15:21)]

dfx2 <- na.omit(dfx)

dfx3 <- unlist(dfx)


dfx_wide <-spread(dfx, compound, value)

class(dfx$v)
symm = T
dfx_wide2 <- na.omit(dfx_wide)
ztable(head(dfx_wide2[2:8])) %>% 
    makeHeatmap %>%
    print(caption="Table 6. Heatmap table with user-defined palette")


```















```{r filter}
library(magrittr)

df_long2 <- df_long %>%
  filter(Group="Rubber")%>%
  group_by(Compound)%>%
  filter(Group="Rubber")%>%
  aggregate(d[, 3:4], list(d$Name), mean)


adf %>%
  add_count(x) %>% 
  filter(n %in% tail(sort(unique(n)),2)) %>% 
  arrange(desc(n))

```

```{r}

```

First make summary
First make a table
Then make heatmap colouring https://cran.r-project.org/web/packages/ztable/vignettes/heatmapTable.html
```{r try to make heatmap table}
install.packages("ztable")
library(ztable)

df_long2 <- df_long[,14:15]

x=table(acs$Dx,acs$smoking)

ztable(head(df_long2)) %>% 
    makeHeatmap(palette="YlOrRd",cols=c(14, 15),margin=2) %>%
    print(caption="Table 8. Columnwise heatmap table")
```



```{r Filter out obs detect freq < 30%}
#df_long2 <- df_long[!is.na(df_long$value),] #there should be no NAs
class(df_long2$value)

#Need to deal with the <LODs. For calculating average we use 0.5xLOD, but only when detection frequency is >30%. Per sample type and category.
n_samples  <- n_distinct(df_long_freq$Site_Category, df_long_freq$Medium_id) # total number of samples

df_long_filtered <- df_long_freq %>% 
  group_by(compound, value) %>% 
  filter(!((n_distinct(Site_Category, Medium_id)/n_samples < 0.50)& (value > 0)))%>% 
  ungroup()

#Need some way to filter out the >30% detection frequency, if >30 perform calculation, if below keep 

#Filter those with <LOD

df_long_X <- cbind(df_long_filtered[,c(1:3,9:10, 14, 16:18)], apply(df_long_filtered[,15, drop=F],2, dLimity))
#is.na(df_long_X$value)
#unique(df_long_X$value)
#when converted to numeric the "<LOD" are converted to NAs. Must make sure that these are included in the rate calculations below. They might be which could solve the problem
class(df_long_X$value)
#remove NAs, should not be NAs here, but still missing data from NILU
df_long_Y <- df_long_X[!is.na(df_long_X$value),] 
#nrow(df_long_X)
```



ilter out those molecules with greater than 50% detection frequency in at least two independent sample types/environmental compartments

```{r filter observations in dample type and environment with obs mor}
#https://stackoverflow.com/questions/47536406/filter-based-on-percentage-of-samples-with-an-observation-in-dplyr
#n_samples  <- n_distinct(df_long2$Site_Category, df_long2$Medium_id) # total number of samples
#n_samples

#check if the filtering is performed per compound!!!
#df_filtered <- df_long2 %>% 
#  group_by(compound, value) %>% 
#  filter(!((n_distinct(Site_Category, Medium_id)/n_samples > 0.50)& (value > 0)))

#nrow(df_filtered)

#write.csv(df_filtered, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230912_TEST_filtercount.csv", row.names=FALSE)

```
