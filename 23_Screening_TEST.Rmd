---
title: "Screening2022_First test"
output: html_document
date: "2023-09-11"
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Functions* 
The following function will replace all "<LOD"
- har det no Ã¥ si om det er mellomrm mellom < og tallet? nei, tror ikke det
```{r}
#function to recognize "<LOD" and to replace with 0.5*LOD. The next step is to use this only for combinations of sample type and site with LOD >30
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for substitution
  as.numeric(v)
}

#Test to set desired number of digits
sigfig <- function(vec, digits){
  return(gsub("\\.$", "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
}
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "tidyr", "egg", "reshape2", "forcats", "RColorBrewer")
lapply(Packages, library, character.only = TRUE)
#trengs disse? "Rmisc", "tidyverse", "lubridate", "stringr",
```

02.07.2024: manual editing of excel-txt file prior to upload.
- removed rows and columns not needed or empty
- replace comma with dot
- removed 45 i in the data. porrible interferences (NILU will check)
- need to sort out how to keep info with groupings
- Make sure that the short name of the molecules is at the bottom
Should be no zero values

12.08.2024
- new updated file used
- metadata hval og hai lagt til
- hvordan behandle "n.a"?
- hvordan behandle "detektert"?
- noen hadde mellomrom mellom < og nummer, fjernet i excel
- KAN IKKE HA BINDESTREK I COMPOUND-NAME)
- decomposes: TIPSIMA	TIPSIA
16.08.2024
- la til manglende metadata hval + info om pakke (ny kolonne!)

```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO")
#df23 <- read.table("240816_240528_SCRE2023_Resultater.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))
df23 <- read.table("240822_240528_SCRE2023_Resultater.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))
```

```{r from wide to long}
df23_long <- gather(df23, compound, value, AOZKF:Fett, factor_key=TRUE)
df23_longg <- subset(df23_long, !is.na(value)) #usikker om denne tar bort alle versjoner av na

#compound BSAN removed since only NAs
#UV320 both NIVA and NILU
```

## Grouping the data
- by part 1 and 2
- by susbtance group
- and by groups of sampling sites/samples
- by sample type?

```{r Groupings}
gr23 <- read.table("Scre23_Groupings2.txt", skip=0, header=TRUE, sep="\t", na.string=c(""))

#count substances per group
gr23x <- gr23 %>%
  group_by(Group) %>%
  mutate(unique_types = n_distinct(ID))

newtable <- merge(df23_longg, gr23, by.x  = "compound", by.y="ID") 

#to check if all are included. can be issues with names. "TIPSIMA" "TIPSIA" decomposed. 
setdiff(df23_long$compound,gr23$ID)
setdiff(df23_long$compound,newtable$compound)

(unique(newtable$compound))

newtable$compound <- revalue(newtable$compound, c("AG"="Ag", "AS"="As", "CD"="Cd", "CR"="Cr", "CU"="Cu", "FE"="Fe", "HG"="Hg", "NI"="Ni", "PB"="Pb", "SB"="Sb", "SE"="Se", "SN"="Sn", "ZN"="Zn"))

newtable$compound <- revalue(newtable$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B-2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF", "X2BDMP"="2BDMP", "F.TOT"="F-TOT" )) #er den siste riktig?

#New column in part2 to separate based on level of predator
newtable$Category <- revalue(newtable$Category, c("H???brann" = "Porbeagle shark", "Piggh???" = "Spiny dogfish", "sperm whale" = "Sperm whale", "H???kjerring"="Greenland shark"))

newtablex = newtable%>%
  mutate(Level = case_when(Category %in% c("Killer whale","Sperm whale", "Harbor porpoise", "White beaked dolphin") ~ "Whale top predator",
                           Category %in% c("Greenland shark", "Porbeagle shark") ~ "Shark top predator",
                                Category %in% c("Humpback whale", "Fin whale") ~ "Whale intermediate predator",
                           Category %in% c("Spiny dogfish") ~ "Shark intermediate predator"))


```

need to make column with frequency and then summary table.
will not rely in NA, but need to define >LOD.
Rather calculate mean later, after LOD has been replaced
```{r Detection frequency}
#Checking:
part1 <- subset(newtablex, Part == "Part1")
part2 <- subset(newtablex, Part == "Part2")

```

```{r Detection frequency}
#remove n.a due to limited sample material. SHould not be included in calculations
part1x <- subset(part1, value != "n.a.")

part1_freq = part1x %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), 
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

#For part 2, use Level instead of category
part2x <- subset(part2, value != "n.a.")

part2_freq = part2x %>%
  group_by(Level, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), #her må det også legges inn "n.a."!!
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 
```

Filter out observations with < 30 detection frequency
#perhaps this one was better? START EHR!!! NOE SOM IKKE STEMMER
```{r Avoid plotting average of those with only < LOD}
part1_filt <- part1_freq %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD 
part1_filt_X <- cbind(part1_filt[,c(1:45)], apply(part1_filt[,46, drop=F],2, dLimity))


part2_filt <- part2_freq %>% 
  mutate(plotting = ifelse(det_frac ==0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD for those with detection frequency above 30%
part2_filt_X <- cbind(part2_filt[,c(1:45)], apply(part2_filt[,46, drop=F],2, dLimity))
```

Calculate mean
- sjekk at ble riktig! ta ut excel f eks
```{r}
part1_finalx = part1_filt_X %>%
  group_by(Category, compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#use either level or category
part2_finalx = part2_filt_X %>%
  group_by(Level, compound, Sample.type) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()
```

##geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 2))), color = "white", size = 5)+
#geom_text(aes(label=ifelse(is.na(meanx), "", round(meanx, digits=3))), color = "white", size = 5)

Set order of substances in plot
```{r}
part1_finalx$compound <- as.character(part1_finalx$compound)
part1_finalx$Group <- as.character(part1_finalx$Group)

part2_finalx$compound <- as.character(part2_finalx$compound)
part2_finalx$Group <- as.character(part2_finalx$Group)
part2_finalx$Sex <- as.character(part2_finalx$Sex)
part2_finalx$Maturity <- as.character(part2_finalx$Maturity)
part2_finalx$Packaging <- as.character(part2_finalx$Packaging)
```

##Part 1
```{r}
#to get "s" for suspect and "n.a." for not available
part1_finalxy <- part1_finalx %>% 
  mutate(meanxyz = ifelse(compound == "BHPMEBD" |compound == "DMPTDPP" | compound =="DMPTTPP"
                          | compound =="Sus62"|compound == "SYLKL"|compound == "SEROLD"|compound =="DIUDP"|compound == "EMOPCC"|compound == "CTCVB"|compound == "DCTCVB"|compound == "DCTCVB"|compound == "TCTDT"|compound == "ETTSDD"|compound == "MPSHDOSD"|compound == "HOTMIKA",
                           "S", 
                           " "))

#removes DTBPPO from NILU, and keep NIVA
#Rename names e.g. starting with a number
unique(part1_finalxy$compound)

part1_finalxyx <- subset(part1_finalxy, compound!="DTBPPO")
part1_finalxy$compound <- revalue(part1_finalxyx$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF", "X2BDMP"="2BDMP", "DTBPPO.1"="DTBPPO" )) #er den siste riktig?

unique(part1_finalxy$compound)
part1_finalxyz <- subset(part1_finalxy, compound!="Fett")

```

### Wastewater treatment plant
```{r Part1 Wastewater treatment pretreatment}
#subset
wwt <- subset(part1_finalxyz, Category == "Wastewater treatment")

#better names for sample types
unique(wwt$Sample.type)

wwt$Sample.type <- revalue(wwt$Sample.type, c("Water, filtered" = "Water, filtered (ng/L)", "Water, particulate" = "Water, particulate (ng/g, d.w.)", "Sludge" ="Sludge (ng/g, d.w.)", "Sediment" ="Marine sediment (ng/g, d.w.)", "Blue mussel" ="Blue mussel (ng/g, w.w.)"))

#set order of dample types
wwt2 <- wwt %>% 
  mutate(Sample.type = factor(Sample.type, levels = c("Water, filtered (ng/L)", "Water, particulate (ng/g, d.w.)", "Sludge (ng/g, d.w.)", "Marine sediment (ng/g, d.w.)", "Blue mussel (ng/g, w.w.)")))

```

BSAN (CAS 1678-25-7) n.a. due to limited sample material? <- na på alle så trenger ikke plotte?
Bisphenol, BHPMEBD (CAS 147504-92-5) suspect screaming only (not relevant for Part 2). 
Triazines, DMPTDPP (CAS 178905-31-2) and DMPTTPP (CAS 178905-32-3) suspect screening only. 
```{r WWTP samples}
#Fjern alle < LOD
#wwt3 <- subset(wwt2, meanx != "NaN") 
wwt3x <- subset(wwt2, det_frac != 0) 

wwt_long2 <- ggplot(wwt3x, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Wastewater treatment plant (scre23)") + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))


ggsave("WW_t2.png", wwt_long2, width = 10, height = 12)

```

### HOTSPOTS (known and unknown)
- dust was separated to private home and commercial manually in excel, if needed
```{r Part1 HOTSPOTS}
#subset
hotspot <- subset(part1_finalxyz, Category%in% c("Known hotspot", "Unknown hotspot"))

unique(hotspot$Sample.type)
#separate dust from homes and commercial
#hotspot$Sample.type[(hotspot$Sample.type == "Dust_private") & (hotspot$Treatmen == "Private home")] <- #"Private home, dust (ng/g, d.w.)"
#hotspot$Sample.type[(hotspot$Sample.type == "Dust_recycling") & (hotspot$X == "Commercial building")] <- "Waste recycling, dust (ng/g, d.w.)"

#better names for sample types
hotspot$Sample.type <- revalue(hotspot$Sample.type, c("Soil" = "Agricultural soils (ng/g, d.w.)", "Product" ="Commercial products (ng/g)", "Dust" = "Indoor dust (ng/g, d.w.)"))

#set the order
hotspot1 <- hotspot %>% 
  mutate(Sample.type = factor(Sample.type, levels = c("Indoor dust (ng/g, d.w.)", "Commercial products (ng/g)", "Agricultural soils (ng/g, d.w.)")))


#known and unknown hotspots together
hotspot2 <- subset(hotspot1, det_frac != 0) 

gju <- subset(hotspot2, compound=="DBT")

HS_t <- ggplot(hotspot2, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
    geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91")+  # determine the colour
    theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Hotspots (known and unknown)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~., scales="free", space="free_y", labeller = label_wrap_gen(width=2))

ggsave("HS_t.png", HS_t, width = 10, height = 12)
```

## Part 2
### Screening substances
SVOC, semi-quantified: Sus62 (CAS 54464-54-9), SYLKL (CAS 676532-44-8), SEROLD (477218-42-1), DIUDP (96507-80-1), EMOPCC (CAS 59151-19-8), CTCVB (CAS 4714-35-6), DCTCVB (CAS  88218-49-9), TCTDT (CAS 2149571-40-2), ETTSDD (CAS 38233-76-0), MPSHDOSD (CAS 125962-78-9), HOTMIKA (CAS 93777-71-0).
HCBD (CAS 87-68-3) not available due to limited sample material. 

OPFR metabolites (n=7) not available for all samples due to limited sample material. 
- whales and sharks
```{r Urban fjord preparation - Part 2}
#REVALUE
part2_finalx$Sample.type <- revalue(part2_finalx$Sample.type, c("Blubber" ="Blubber (ng/g, w.w.)", "Liver" = "Liver (ng/g, w.w.)", "Muscle"="Muscle (ng/g, w.w.)"))


part2_finalx$compound <- revalue(part2_finalx$compound, c("BENAZOL.P"="BENAZOL P", "X2BBTMP"="2BBTMP",  "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X2TBCLBEP"="2TBCLBEP",
                                                            "X42FTS"="42FTS", "X62FTS"="62FTS", "X82FTS"="82FTS", "X102FTS"="102FTS", "X122FTS"="122FTS", "X2BDMP"="2BDMP"))

#to get "s" for suspect and "n.a." for not available
part2_finalxcc <- part2_finalx %>% 
  mutate(meanxyz = ifelse(compound == "BHPMEBD" |compound == "DMPTDPP" | compound =="DMPTTPP"
                          | compound =="Sus62"|compound == "SYLKL"|compound == "SEROLD"|compound =="DIUDP"|compound == "EMOPCC"|compound == "CTCVB"|compound == "DCTCVB"|compound == "DCTCVB"|compound == "TCTDT"|compound == "ETTSDD"|compound == "MPSHDOSD"|compound == "HOTMIKA",
                           "S", 
                           " "))


```

```{r Part2 scre23}
#SUBSET
part2_finalxy23 <- subset(part2_finalxcc, Extra == "Scre23")

#SET THE ORDER IN PLOT
part2_finalxy23x <- part2_finalxy23 %>% 
  mutate(Level = factor(Level, levels = c("Whale top predator", "Whale intermediate predator", "Shark top predator", "Shark intermediate predator")))

#known and unknown hotspots together
part2_finalxy24x <- subset(part2_finalxy23x, det_frac != 0) 

part2_finalxy24xx <- subset(part2_finalxy24x, compound !="Fett")


#PLOTTING
WS_23 <- ggplot(part2_finalxy24xx, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 4)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=17,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,180,10),
        strip.text.x = element_text(size = 14),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Whales and sharks (scre23)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))
 
ggsave("WS_23.png", WS_23, width = 8, height = 5) 
```

### Extra(urban fjord) substances
- whales and sharks
```{r Part2 Extra}
part2_extra <- subset(part2_finalxcc, Extra == "Extra")

part2_extra1 <- part2_extra %>% 
  mutate(Level = factor(Level, levels = c("Whale top predator", "Whale intermediate predator", "Shark top predator", "Shark intermediate predator")))

#sh <- subset(part2_UF_1, Level =="Whale top predator"& compound=="LCCP")
#sd <- subset(part2_extra1, Level =="Whale top predator"& compound=="LCCP")

part2_UF_1 <- subset(part2_extra1, Group %in% c("CP", "Dechlorane", "nBFR", "OPFR", "OPFR_metabolite"))
part2_UF_2 <- subset(part2_extra1, Group %in% c("nPFAS", "PBDE", "PCB"))
part2_UF_3 <- subset(part2_extra1, Group %in%c("PFCA", "PFSA", "QNH4", "UV") | compound=="Hg")

part2_UF_1x <- subset(part2_UF_1, det_frac != 0) 
part2_UF_2x <- subset(part2_UF_2, det_frac != 0) 
part2_UF_3x <- subset(part2_UF_3, det_frac != 0) 

#part2_finalxc <- subset(part2_finalx, compound !="Fett")

UF1 <- ggplot(part2_UF_1x, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 4)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91") +# determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=17,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,210,60),
        strip.text.x = element_text(size = 14),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Whales and sharks (UF 1/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

UF2 <- ggplot(part2_UF_2x, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 4)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91")+  # determine the colour
 theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=17,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,240,2),
        strip.text.x = element_text(size = 14),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Whales and sharks (UF 2/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))

UF3 <- ggplot(part2_UF_3x, aes(x=Sample.type, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label= ifelse(meanxyz=="S", meanxyz, ifelse(is.na(meanx), " ", as.numeric(sigfig(meanx, 1))))), color = "white", size = 5)+
  #geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 4)+
 scale_fill_gradient2(low = "#74C476", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=17,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 12, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.85, 0.96),
        legend.direction = "horizontal",
        plot.margin = margin(1.3, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,210,-10),
        strip.text.x = element_text(size = 14),
        panel.spacing.x = unit(0.2, "lines"),
        legend.title=element_text(size=12), 
        strip.text.y = element_text(angle = 0, size=12)) +
  ggtitle("Whales and sharks (UF 3/3)") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(Group~Level, scales="free", space="free_y", labeller = label_wrap_gen(width=2))
#save
ggsave("Part1_UF1.png", UF1, width = 8, height = 7)
ggsave("Part1_UF2.png", UF2, width = 8, height = 12)
ggsave("Part1_UF3.png", UF3, width = 8, height = 8)

```

# Exploring site specific contamination patterns
- if using average values, need to make sure that the averages are calculated correctly based on grouping
- do we caare about the detection frequency here? and how to deal with < LOD?
- here we can include all data and only do the average, not the >30% detection (?)

1) Waste water treatment
- are thre differences between high and low treatment? water and solids
- are there differences between time points of sampling?

a) wastewater treatment high and low, and with recipient below 
```{r Wastewater treatment high and low}
#gjennomsnitt på skille på purification degree
#"n.a." already removed

#We only need water filtered, water particles, and sludge
part1xx <- subset(part1x, Matrix == c("Wastewater treated"))

part1_freq_ww = part1xx %>%
  group_by(compound, Sample.type, Treatmen) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part1_filt_ww <- part1_freq_ww %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "<LOD", 
                           value))

part1_filt_ww1 <- cbind(part1_filt_ww[,c(1:44)], apply(part1_filt_ww[,45, drop=F],2, dLimity))

part1_final_ww2 = part1_filt_ww1 %>%
  group_by(Category, compound, Sample.type, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

part1_final_ww2$compound <- as.character(part1_final_ww2$compound)
part1_final_ww2$Group <- as.character(part1_final_ww2$Group)


#to get "s" for suspect and "n.a." for not available
part1_final_ww2a <- subset(part1_final_ww2, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA"))

#Rename names e.g. starting with a number
part1_final_ww2aa <- subset(part1_final_ww2a, compound!="DTBPPO")

part1_final_ww2aa$compound <- revalue(part1_final_ww2aa$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF", "X2BDMP"="2BDMP", "DTBPPO.1"="DTBPPO" )) #er den siste riktig?

part1_final_ww3 <- subset(part1_final_ww2aa, compound!="Fett")


#rename
part1_final_ww3$Sample.type <- revalue(part1_final_ww3$Sample.type, c("Water, filtered" = "Water, filt. (ng/L)", "Water, particulate" = "Water, part. (ng/g, d.w.)", "Sludge" ="Sludge (ng/g, d.w.)"))

#set order
part1_final_ww3$Sample.type <- factor(part1_final_ww3$Sample.type, levels=c("Water, filt. (ng/L)", "Water, part. (ng/g, d.w.)", "Sludge (ng/g, d.w.)")) 
#Fjern alle < LOD
part1_final_ww4 <- subset(part1_final_ww3, meanx != "NaN") 

#remove the duplicated values, but value and plotting are different so must first be removed
part1_final_ww5 <- distinct(part1_final_ww4, meanx, Sample.type, compound, Treatmen, .keep_all= TRUE) 

#part1_final_ww3<- part1_final_ww2x[!duplicated(part1_final_ww2x), ]
part1_final_ww5$Treatmen = factor(part1_final_ww5$Treatmen, levels = c("Low purification", "High purification") )

ggplot(part1_final_ww5, aes(y=(meanx), x=fct_rev(compound), fill=Treatmen))+
  #geom_col(position = position_dodge2(preserve = "single")) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_col(position="dodge", width = 0.5)+
  scale_fill_manual(values=c( "dodgerblue2", "dodgerblue4"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=14, colour="black"),
        axis.text.y = element_text(size=12, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=15, margin = margin(t = 0, r = 20, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=14, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.text=element_text(size=15),
        legend.position="top",
        legend.title=element_blank())+
  facet_grid(Sample.type~Group, scales="free", space='free_x')+
  ylab("log(concentration)+5")

ggsave("WWT_treatment.png", WWT_treatment, width = 12, height = 11)
```

b) indoor dust - private homes and recycling facility
```{r Dust private and recycling}
# skille på purification degree
dust <- subset(part1x, Sample.type == "Dust")

dust1 = dust %>%
  group_by(Treatmen, compound) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

dust2 <- dust1 %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "< LOD", 
                           value))

dust3 <- cbind(dust2[,c(1:44)], apply(dust2[,45, drop=F],2, dLimity))

dust4 = dust3 %>%
  group_by(compound, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#part1_final_duy <- subset(part1_final_du, det_frac > 30)
#part1_final_duyz <- subset(part1_final_duy, compound != "Fett")
dust4$compound <- as.character(dust4$compound)
dust4$Group <- as.character(dust4$Group)
dust4$Treatmen <- as.character(dust4$Treatmen)



#to get "s" for suspect and "n.a." for not available
dust4a <- subset(dust4, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA"))

#Rename names e.g. starting with a number
dust4aa <- subset(dust4a, compound!="DTBPPO")

dust4aa$compound <- revalue(dust4aa$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B.2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF", "X2BDMP"="2BDMP", "DTBPPO.1"="DTBPPO" )) #er den siste riktig?


#rename
#dust4aa$Treatmen <- revalue(dust4aa$Treatmen, c("Recycling facility"="Recycling facility, dust ", "Private #home" = "Private homes, dust (ng/g, d.w.)"))

#set order (also for products used blow)
#dust4aa$Treatmen <- factor(dust4aa$Treatmen, levels=c("Recycling facility, dust (ng/g, d.w.)", "Private homes, #dust (ng/g, d.w.)")) 

#Fjern alle < LOD
dust5 <- subset(dust4aa, meanx != "NaN") 

#remove the duplicated values, but value and plotting are different so must first be removed
dust6 <- distinct(dust5, meanx, Sample.type, compound, Treatmen, .keep_all= TRUE) 


dust <- ggplot(dust6, aes(y=log(meanx), x=compound, fill=Treatmen))+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_col(position="dodge")+
  scale_fill_manual(values=c("orangered3", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=15, margin = margin(t = 0, r = 20, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=13, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=15))+
  facet_grid(~Group, scales="free_x", space='free_x')+
  ylab("log(concentration)")

ggsave("DUST.png", dust, width = 10, height = 7)

#  legend.position = "none"
```

c)
```{r Products}
prod <- subset(part1x, Sample.type=="Product")

prod1 = prod %>%
  group_by(Treatmen, compound) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

prod2 <- prod1 %>% 
  mutate(plotting = ifelse(det_frac == 0, 
                           "< LOD", 
                           value))

prod3 <- cbind(prod2[,c(1:44)], apply(prod2[,45, drop=F],2, dLimity))

prod4 = prod3 %>%
  group_by(compound, Treatmen) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#part1_final_duy <- subset(part1_final_du, det_frac > 30)
#part1_final_duyz <- subset(part1_final_duy, compound != "Fett")
prod4$compound <- as.character(prod4$compound)
prod4$Group <- as.character(prod4$Group)
prod4$Treatmen <- as.character(prod4$Treatmen)


#to get "s" for suspect and "n.a." for not available
prod4x <- subset(prod4, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA"))

#Fjern alle < LOD
prod5 <- subset(prod4x, meanx != "NaN") 


ggplot(prod5, aes(y=(meanx), x=compound, fill=Treatmen))+
  #geom_col(position="dodge")+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour="darkgrey")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=15, margin = margin(t = 0, r = 20, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.title=element_blank(),
        legend.text=element_text(size=14))+
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log(ng/L, d.w.)+10")+
  scale_fill_brewer(palette = "Set1")+
  ylab("log(concentration)")
  
             
ggsave("PRODUCTS.png", products, width = 10, height = 6)

```

d) WHALES AND SHARKS
- need to new averages, not based on level but on category (+ sample type and compound)
```{r}
#allerede fjernet er "n.a."
part2_freq_2 = part2x %>%
  group_by(Group, compound, Sample.type) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))), 
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

part2_final_2 <- part2_freq_2 %>% 
  mutate(plotting = ifelse(det_frac ==0, 
                           "<LOD", 
                           value))

# claculate 0.5xLOD for those with detection frequency above 30%
#part2_filt_X_2 <- cbind(part2_filt_2[,c(1:45)], apply(part2_filt_2[,46, drop=F],2, dLimity))

#Category - for part 2 of report
#part2_final_2 = part2_filt_2 %>%
#  group_by(Category, compound, Sample.type) %>%
#  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
#  ungroup()

part2_final_2$compound <- as.character(part2_final_2$compound)
part2_final_2$Group <- as.character(part2_final_2$Group)
part2_final_2$Sex <- as.character(part2_final_2$Sex)
part2_final_2$Maturity <- as.character(part2_final_2$Maturity)
part2_final_2$Packaging <- as.character(part2_final_2$Packaging)

#to get "s" for suspect and "n.a." for not available
part2_final_3 <- subset(part2_final_2, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA"))

```

- whales (blubber) and sharks (liver) - trophic level
```{r trophic level}
topP3 <- subset(part2_final_3, Sample.type =c("Blubber", "Liver"))
#rename
topP3$Level <- revalue(topP3$Level, c("Shark intermediate predator" = "Shark intermediate (liver)", "Shark top predator" = "Shark top (liver)", "Whale intermediate predator" = "Whale intermediate (blubber)", "Whale top predator"= "Whale top (blubber)"))

#set order (also for products used blow)
topP3$Level <- factor(topP3$Level, levels=c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)")) 
topP4 <- subset(topP3, !compound %in% c("Ag","As","Cd","Cr", "Cu","Fe","Ni","Pb","Sb","Se","Sn","Zn"))

#frqf <- subset(topP5, Group=="QNH4") 

#remove nas
topP5 <- subset(topP4, plotting != "<LOD") 
topP5$plotting <- as.numeric(topP5$plotting)
topP6 <- subset(topP5, plotting != "NaN")

topP6z <- subset(topP6, compound !="Fett")

topP6z$compound <- as.character(topP6z$compound)
whales <- ggplot(topP6z, aes(x=compound, y=plotting, colour=Level, shape=Level))+
  geom_point(size=3.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=11, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=14))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log10(concentration)")+
  scale_colour_manual(name = "Tissue",
                      labels = c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)"),
                      values = c("dodgerblue3", "green3", "plum", "orange1"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)"),
                     values = c(19, 17, 19, 17))+
  guides(color = guide_legend(override.aes = list(size=4)))

  
ggsave("Whale groups2.png", whales, width = 10, height = 8)

```

```{r Packaging}

topP4$value <- as.numeric(topP4$value)

pack <- ggplot(topP6z, aes(x=compound, y=plotting, colour=Packaging))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=13, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
       legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=16))+
    scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log10(concentration)")

 ggsave("packaing2.png", pack, width = 10, height = 8)
```

-whale species
```{r}
topP7 <- subset(topP6, Treatmen == "Whales" & Sample.type=="Blubber")

#unique(topP7$Category)
topP7$Category <- factor(topP7$Category, levels=c("Killer whale", "Sperm whale", "Harbor porpoise", "Fin whale", "Humpback whale")) 
topP7$plotting <- as.numeric(topP7$plotting)

#remove nas
topP8 <- subset(topP7, plotting != "NaN") 

jl <- subset(topP8, compound !="Fett")

w_species <- ggplot(jl, aes(x=compound, y=plotting, colour=Category, shape=Category))+
  geom_point(size=4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=14))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  #scale_colour_brewer(palette = "Set1")+
  ylab("log10(concentration)")+
    scale_colour_manual(name = "Tissue",
                      labels = c("Killer whale", "Sperm whale", "Harbor porpoise", "Fin whale", "Humpback whale"),
                      values = c("steelblue1", "dodgerblue3",  "black", "orchid1", "orchid3"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Killer whale", "Sperm whale",  "Harbor porpoise", "Fin whale", "Humpback whale"),
                     values = c(19, 19, 19, 19, 19, 19))+
  guides(color = guide_legend(override.aes = list(size=4.5)))
  

ggsave("Whale species2.png", w_species, width = 10, height = 7)
```

- whales effect from age  (/whale blubber)
```{r}

topP8$Sex <- as.character(topP8$Sex)
topP8$Maturity <- as.character(topP8$Maturity)
topP8$Group <- as.character(topP8$Group)

#remove the young killer whale
sss <- subset(topP8, Length!=390)
topP9<- subset(topP8, compound!="Fett")
topP10<- subset(topP9, Group!="Antioxidant")

as <- ggplot(topP10, aes(x=compound, y=plotting, colour=Maturity, shape=Maturity))+
  geom_point(size=4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=13, colour="black"),
        strip.text.y = element_text(size=13, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=17))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  #scale_colour_brewer(palette = "Set1")+
  ylab("log10(concentration)")+
      scale_colour_manual(name = "Maturity",
                      labels = c("Adult", "Subadult", " "),
                      values = c("steelblue1", "dodgerblue3",  "black"))+    
  scale_shape_manual(name = "Maturity",
                     labels = c("Adult", "Subadult", " "),
                     values = c(16, 18, 5))+
  guides(color = guide_legend(override.aes = list(size=4.5)))

ggsave("age and sex2.png", as, width = 10, height = 7)

```

- different tissue of harbour porpoise
```{r}
topP6x <- subset(topP6, Category=="Harbor porpoise"&Length==136)
#remove nas
topP7x <- subset(topP6x, plotting != "NaN") 


w_tissue <- ggplot(topP7x, aes(x=compound, y=(plotting), shape=Sample.type, colour= Sample.type))+
  geom_point(size=4.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=15))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log10(concentration)")+
  scale_colour_manual(name = "Tissue",
                      labels = c("Blubber", "Liver", "Muscle"),
                      values = c("dodgerblue4", "orange1", "palevioletred2"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Blubber", "Liver", "Muscle"),
                     values = c(19, 16, 18))
  

ggsave("Whale tissue2.png", w_tissue, width = 10, height = 7)

```

- sharks
```{r sharks}
#find back the metadata!!! and perhaps also the stable isotopes
shark <- subset(topP6, Treatmen=="Sharks")
#blub <- subset(topP4, Sample.type=="Blubber")

part2_final_2$Group <- as.character(part2_final_2$Group)

shark$value <- as.numeric(shark$value)

#New column in part2 to separate based on level of predator
#remove nas
shark <- subset(shark, plotting != "NaN") 

shark$Category <- factor(shark$Category, levels=c("Greenland shark", "Porbeagle shark", "Spiny dogfish")) 
shark1 <- subset(shark, compound!="Fett")

shark1$compound <- as.character(shark1$compound)
SHARKY <- ggplot(shark1, aes(x=(compound), y=(plotting), colour=Category, shape=Category))+
  geom_point(size=4)+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=15))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log10(concentration)")+
  facet_grid(.~Group, scales="free", space='free_x')+
  scale_colour_manual(name = "Specie and tissue",
                      labels = c("Greenland shark, muscle", "Porbeagle shark, liver",  "Spiny dogfish, liver"),
                      values = c("green4","green3", "orange1"))+
  scale_shape_manual(name = "Specie and tissue",
                     labels = c("Greenland shark, muscle", "Porbeagle shark, liver",  "Spiny dogfish, liver"),
                     values = c(17, 18, 18))
  
  

ggsave("SHARKY2.png", SHARKY, width = 10, height = 7)


```




##Divide concentration by FAT content
- trophic level / fat (%)
```{r}
df23_longx <- gather(df23, compound, value, AOZKF:F.TOT, factor_key=TRUE)

newtablex <- merge(df23_longx, gr23, by.x  = "compound", by.y="ID") 

#to check if all are included. can be issues with names. "TIPSIMA" "TIPSIA" decomposed. 
#setdiff(df23_longx$compound,gr23x$ID)
#setdiff(df23_longx$compound,newtablex$compound)

(unique(newtablex$compound))

newtablex$compound <- revalue(newtablex$compound, c("AG"="Ag", "AS"="As", "CD"="Cd", "CR"="Cr", "CU"="Cu", "FE"="Fe", "HG"="Hg", "NI"="Ni", "PB"="Pb", "SB"="Sb", "SE"="Se", "SN"="Sn", "ZN"="Zn"))

newtablex$compound <- revalue(newtablex$compound, c("BENAZOL.P"="BENAZOL P", "X23BPDT"="23BPDT", "X34DMPZ"="34DMPZ", "X2BBTMP"="2BBTMP", "X34DMPZP"="34DMPZP", "X35DMPZ"="35DMPZ", "X2BDOMP"="2BDOMP", "X4NAS"="4NAS", "B-2ETF"="B-2ETF", "X2BHMPTP"="2BHMPTP", "X2BMPP"="2BMPP", "X2BMTP"="2BMTP", "X22BPDT"="22BPDT", "X2TBCLBEP"="2TBCLBEP", "B.2ETF"="B-2ETF", "X2BDMP"="2BDMP", "F.TOT" = "F-TOT" )) #er den siste riktig?


#New column in part2 to separate based on level of predator
newtablex$Category <- revalue(newtablex$Category, c("H???brann" = "Porbeagle shark", "Piggh???" = "Spiny dogfish", "sperm whale" = "Sperm whale", "H???kjerring"="Greenland shark"))

part30 = newtablex%>%
  mutate(Level = case_when(Category %in% c("Killer whale","Sperm whale", "Harbor porpoise", "White beaked dolphin") ~ "Whale top predator",
                           Category %in% c("Greenland shark", "Porbeagle shark") ~ "Shark top predator",
                                Category %in% c("Humpback whale", "Fin whale") ~ "Whale intermediate predator",
                           Category %in% c("Spiny dogfish") ~ "Shark intermediate predator"))

part30$Level <- revalue(part30$Level, c("Shark intermediate predator" = "Shark intermediate (liver)", "Shark top predator" = "Shark top (liver)", "Whale intermediate predator" = "Whale intermediate (blubber)", "Whale top predator"= "Whale top (blubber)"))

#set order (also for products used blow)
part30$Level <- factor(part30$Level, levels=c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)")) 
part31 <- subset(part30, !compound %in% c("Ag","As","Cd","Cr", "Cu","Fe","Ni","Pb","Sb","Se","Sn","Zn", "BHPMEBD", "DMPTDPP", "DMPTTPP","Sus62", "SYLKL", "SEROLD","DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA"))


#remove those that do not have fat
part31x <- subset(part31, !is.na(Fett))
part31x$value <- as.numeric(part31x$value)
part32 <- subset(part31x, !is.na(value))

#part31$plotting2 <- part31$plotting:part31$Fett

part32 <- mutate(part32, new = value / (Fett/100))

#dj <- subset(part34, compound=="F-TOT")

part33 = part32%>%
  mutate(Level = case_when(Category %in% c("Killer whale","Sperm whale", "Harbor porpoise", "White beaked dolphin") ~ "Whale top predator",
                           Category %in% c("Greenland shark", "Porbeagle shark") ~ "Shark top predator",
                                Category %in% c("Humpback whale", "Fin whale") ~ "Whale intermediate predator",
                           Category %in% c("Spiny dogfish") ~ "Shark intermediate predator"))

```

##Trophic level (liver and blubber)
```{r}

#hvis bare liver og blubber
part34 <- subset(part33, Sample.type %in% c("Blubber", "Liver"))
class(part34$new)

part34$Level <- revalue(part34$Level, c("Shark intermediate predator" = "Shark intermediate (liver)", "Shark top predator" = "Shark top (liver)", "Whale intermediate predator" = "Whale intermediate (blubber)", "Whale top predator"= "Whale top (blubber)"))

#set order (also for products used blow)
part34$Level <- factor(part34$Level, levels=c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)")) 

fat_whale <- ggplot(part34, aes(x=fct_rev(compound), y=(new), colour=Level, shape=Level))+
  geom_point(size=3.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=11, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=14))+
   scale_y_continuous(trans='log10') +  
  facet_grid(.~Group, scales="free", space='free_x')+
  ylab("log(concentration:fat)")+
  scale_colour_manual(name = "Tissue",
                      labels = c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)"),
                      values = c("dodgerblue3", "green3", "plum", "orange1"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Whale top (blubber)","Shark top (liver)", "Whale intermediate (blubber)", "Shark intermediate (liver)"),
                     values = c(19, 17, 19, 17))+
  guides(color = guide_legend(override.aes = list(size=4)))
  
  
ggsave("whales_fat2.png", fat_whale, width = 10, height = 7)
```

- whale species / fat (%)
```{r}

part34x <- subset(part33, Treatmen == "Whales" & Sample.type=="Blubber")

part34x$compound <- as.character(part34x$compound)

part34x$Category <- factor(part34x$Category, levels=c("Killer whale", "Sperm whale", "Harbor porpoise", "Fin whale", "Humpback whale")) 

w_species_fat <- ggplot(part34x, aes(x=(compound), y=new, colour=Category, shape=Category))+
  geom_point(size=4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=14, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=14))+
  scale_y_continuous(trans='log10') +  
  facet_grid(.~Group, scales="free", space='free_x')+
  #scale_colour_brewer(palette = "Set1")
   ylab("log(concentration:fat)")+
    scale_colour_manual(name = "Tissue",
                      labels = c("Killer whale", "Sperm whale", "Harbor porpoise", "Fin whale", "Humpback whale"),
                      values = c("steelblue1", "dodgerblue3",  "black", "orchid1", "orchid3"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Killer whale", "Sperm whale",  "Harbor porpoise", "Fin whale", "Humpback whale"),
                     values = c(19, 19, 19, 19, 19, 19))+
  guides(color = guide_legend(override.aes = list(size=4.5)))
  

ggsave("Whale species_FAT2.png", w_species_fat, width = 10, height = 7)
```

- tissue type/fat
```{r}
part34y <- subset(part33, Category=="Harbor porpoise"&Length==136)
#remove nas
topP7x <- subset(topP6x, plotting != "NaN") 

part34y$compound <- as.character(part34y$compound)
w_tissue_fat <- ggplot(part34y, aes(x=compound, y=new, shape=Sample.type, colour= Sample.type))+
  geom_point(size=4.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=15))+
  scale_y_continuous(trans='log10') +  
  facet_grid(.~Group, scales="free", space='free_x')+
    ylab("log(concentration:fat)")+
  scale_colour_manual(name = "Tissue",
                      labels = c("Blubber", "Liver", "Muscle"),
                      values = c("dodgerblue4", "orange1", "palevioletred2"))+    
  scale_shape_manual(name = "Tissue",
                     labels = c("Blubber", "Liver", "Muscle"),
                     values = c(19, 16, 18))
  

ggsave("Whale tissue_FAT2.png", w_tissue_fat, width = 10, height = 7)
```

- Age effect /fat
- subset whale blubber
```{r}

ioh <- subset(part34x, Group=="Antioxidant")

as_FAT <- ggplot(part34x, aes(x=compound, y=new, colour=Maturity, shape=Maturity))+
  geom_point(size=4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=13, colour="black"),
        strip.text.y = element_text(size=13, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=17))+
  scale_y_continuous(trans='log10') +
  facet_grid(.~Group, scales="free", space='free_x')+
  #scale_colour_brewer(palette = "Set1")+
  ylab("log(concentration:fat)")+
      scale_colour_manual(name = "Maturity",
                      labels = c("Adult", "Subadult", " "),
                      values = c("steelblue1", "dodgerblue3",  "black"))+    
  scale_shape_manual(name = "Maturity",
                     labels = c("Adult", "Subadult", " "),
                     values = c(16, 18, 5))+
  guides(color = guide_legend(override.aes = list(size=4.5)))

ggsave("age and sex_FAT2.png", as_FAT, width = 10, height = 7)


```

- Sharks/fat
```{r}
#shark <- subset(topP6, Treatmen=="Sharks")
shark <- subset(part33, Treatmen %in% c("Sharks"))

shark$Group <- as.character(shark$Group)

shark$value <- as.numeric(shark$value)

#New column in part2 to separate based on level of predator
#remove nas
#shark <- subset(shark, plotting != "NaN") 

shark$Category <- factor(shark$Category, levels=c("Greenland shark", "Porbeagle shark", "Spiny dogfish")) 
shark1 <- subset(shark, compound!="Fett")

SHARKY_fat <- ggplot(shark, aes(x=fct_rev(compound), y=(value), colour=Category, shape=Category))+
  geom_point(size=4)+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position="top",
        legend.title=element_blank(),
        legend.text=element_text(size=15))+
  scale_y_continuous(trans='log10') +
  ylab("log(concentration:fat)")+
  facet_grid(.~Group, scales="free", space='free_x')+
  labs(ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(.~Group, scales="free", space='free_x')+
  scale_colour_manual(name = "Specie and tissue",
                      labels = c("Greenland shark, muscle", "Porbeagle shark, liver",  "Spiny dogfish, liver"),
                      values = c("green4","green3", "orange1"))+
  scale_shape_manual(name = "Specie and tissue",
                     labels = c("Greenland shark, muscle", "Porbeagle shark, liver",  "Spiny dogfish, liver"),
                     values = c(17, 18, 18))
  
  

ggsave("SHARKY_FAT.png", SHARKY_fat, width = 10, height = 7)
```





Se på stabil isotop
```{r}
topP4$Delta.13C <- as.numeric(topP4$Delta.13C)
topP4$Delta.15N <- as.numeric(topP4$Delta.15N)

topP4_x <- distinct(topP4, Sample.type, W..C.N, Treatmen, .keep_all= TRUE) 
topP4_y <- distinct(topP4, Sample.type, Delta.13C, Treatmen, .keep_all= TRUE) 
topP4_z <- distinct(topP4, Sample.type, Delta.15N, Treatmen, .keep_all= TRUE) 


ggplot(subset(topP4_x, !is.na(W..C.N)), aes(x=Category, y=W..C.N))+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="W..C.N", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(Sample.type~., scales="free", space='free_x')
  
  ggplot(subset(topP4_y, !is.na(Delta.13C)), aes(x=Category, y=Delta.13C))+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Delta.13C", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(Sample.type~., scales="free", space='free_x')
  
  
ggplot(subset(topP4_z, !is.na(Delta.15N)), aes(x=Category, y=Delta.15N))+
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))+
  #geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  labs(title="Delta.15N", ylab="Concentration log(ng/g, w.w.)+10")+
  facet_grid(Sample.type~., scales="free", space='free_x')

```


PNEC FIGUE
The following compounds: PF201, DABPA, UV310, UV1164, BEMT,BPAP2,TBPHT,B-2ETF,CUMIN,CBZL,BDPME,TMPID,DPMPE,BZBA,FEFAC,MABT,DMPSHEN,DTBMMP,CB28,CB52,CB101,CB118,CB,38,CB153,CB180,BDE17,BDE28,BDE47,BDE49,BDE66,BDE77,BDE85,BDE99,BDE100,BDE119,BDE126,BDE138,BDE153,BDE154,BDE156,BDE183,BDE184,BDE191,BDE196,BDE197,BDE202,BDE206,BDE207,SCCP,MCCP,LCCP,TBECHB,TBECHG,BATE,PBEB ,QCB,HCB,DDC_DBF,DDC_ANT,DDC_PS,DDC_PA,CR,FE,NI,CU,ZN,AS,SE,AG,CD,SN,SB,PB,HG,TTBPP,DEHPO,DOCDPA,DPGUAN,UV1130,KRYFIO,ETPPBR,ADNP,GBLA,BZDSA,UV329,SG3,UV360,UV234,DTBPPO,UV384,BAC_C12,BAC_C14,DADMAC_C10,ATAC_C12,ATAC_C14,A,AC_C16,ATAC_C18,UV327,OCTOC,PFNA,PFDA,PFUNDA,PFDODA,PFTRDA,PFHXS,PFOS,PFBSA,NMEFBSA,PFOSA

```{r Making the PNEC Figure}
#Based on the information provied, the following compounds are of interest. Perhaps excluding L9 and L10 due to suspect screening. Others from NIVA? Check
library(magrittr)
#tar ut "DBM",  for under LOD, eventuelt sjekk
newtablexx <- subset(newtablex, value != "n.a.")
#følgende gjør om alle "< LOD" observasjoner til NA slik at de ikke inkluderes som minimumsverdi
newtablexx$value <- as.numeric(newtablexx$value)
newtablexxx <- newtablexx %>% drop_na(value)

pnec <- subset(newtablexxx, compound %in% c("PF201", "DABPA", "UV310", "UV1164","BEMT","BPAP2","TBPHT","B-2ETF","CUMIN","CBZL","BDPME","TMPID","DPMPE","BZBA","FEFAC","MABT","DMPSHEN","DTBMMP","CB28","CB52","CB101","CB118","CB38","CB153","CB180","BDE17","BDE28","BDE47","BDE49","BDE66","BDE71","BDE77","BDE85","BDE99","BDE100","BDE119","BDE126","BDE138","BDE153","BDE154","BDE156","BDE183","BDE184","BDE191","BDE196","BDE197","BDE202","BDE206","BDE207","SCCP","MCCP","LCCP","TBECHB","TBECHG","BATE","PBEB" ,"QCB","HCB","DDC_DBF","DDC_ANT","DDC_PS","DDC_PA","Cr","Fe","Ni","Cu","Zn","As","Se","Ag","Cd","Sn","Sb","Pb","Hg","TTBPP","DEHPO","DOCDPA","DPGUAN","UV1130","KRYFIO","ETPPBR","ADNP","GBLA","BZDSA","UV329","SG3","UV360","UV234","DTBPPO","UV384","BAC_C12","BAC_C14","DADMAC_C10", "ATAC_C12","ATAC_C14","AAC_C16","ATAC_C18","UV327","OCTOC","PFNA","PFDA","PFUNDA","PFDODA","PFTRDA","PFHXS","PFOS","PFBSA","NMEFBSA","PFOSA"))

pnec3 <- pnec%>%
  mutate(sample_category = case_when
         (Sample.type %in% c("Water, filtered") ~ "Freshwater",
          Sample.type %in% c("Sludge", "Soil", "Sediment") ~ "Sediment",
          Sample.type %in% c("Blubber", "Blue mussel", "Liver", "Muscle") ~ "Biota_marine_fish"))

#filter out max an min values for each category. Wich categories to choose? 
pnec_max_minx <- pnec3 %>%
  group_by(compound, sample_category) %>% #bruk noe annet enn treatment. Må tilpasses pnec kategorier. lage nye
  mutate(Min = min(value), Max = max(value))


#Make new categories to match the PNEC categories of freswater, sediment og biota
#not using air values here
#pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")

#Laste opp fil med PNEC verdier. Laget fra info i word
#condition and sample category
# short and compound
dx <- read.table("PNECs Screening 23_v2.txt", header=TRUE, sep="\t", na.string=c(""))

#Calculate to the correct abbreviations
dx$Freshwater <- dx$Freshwater *1000
#dx$Sediment2 <- dx$Sediment *1
#dx$Biota2 <- dx$Biota*1

#delete those missing for all categories
dxx <- dx[ -c(6) ]
x <- dxx[rowSums(is.na(dxx[,4:6]))!=3,]

dx_long <- gather(x, sample_category, limit, Freshwater:Biota_marine_fish, factor_key=TRUE)

#one may have wrong class
#pnec_max_min4 <- as.data.frame(pnec_max_min2)
#subsetting to keep only those with match
#pnec_max_min4$sample_category <- revalue(pnec_max_min4$sample_category, c("Freshwater"="Freshwater2"))

#pnec_max_min5 <- subset(pnec_max_min4, sample_category%in% c("Freshwater2", "Sediment2", "Biota2"))



#MERGE. Til pnec_max_min2 skal vi fra dx legge til alle kolonner ved å matche 
dx2 <- merge(x=pnec_max_minx,y=dx_long, by=c(as.character("compound"), as.character("sample_category")),
             all.x=TRUE)

nrow(pnec_max_minx)
#substances to be excluded
dx2x <- subset(dx2, !compound %in% c("BHPMEBD", "DMPTDPP", "DMPTTPP", "Sus62", "SYLKL", "SEROLD", "DIUDP", "EMOPCC", "CTCVB", "DCTCVB", "DCTCVB", "TCTDT", "ETTSDD", "MPSHDOSD", "HOTMIKA", "Fett"))

#ARE THRER wrong abbreviations for pnec??

write.csv(dx2x, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/240826_TEST_pnec.csv", row.names=FALSE)
```



```{r Cleaning up before plotting}
#remove duplicate rows before plotting
dx3 <-dx2x %>% 
  distinct(Min, Max, compound, sample_category, .keep_all = TRUE)

#remove those not fitting into the pnec categories
dx4 <- dx3[!is.na(dx3$sample_category),]
dx5 <- dx4[!is.na(dx4$limit),]
unique(dx4$compound)

write.csv(dx5, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/240826_TEST_pnec_2.csv", row.names=FALSE)

```

```{r PNEC plot}
#dx5 <- as.numeric(dx5$limit)

rfe <- subset(dx5, group=="PBDE")

pnecopp <- ggplot(dx5, aes(y=fct_rev(compound), x=value, xmin = Min, xmax=Max, colour = sample_category))+ 
  geom_linerange(aes(colour = sample_category, alpha=1), linewidth=2.5, position = position_dodge2(width = 0.7))+
  geom_point(aes(x=(limit), fill = sample_category),  size=6, shape=18, position = position_dodge2(width = 0.7))+
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1,vjust=1,size = 15,colour="black"),
        axis.text.y = element_text(size = 15,colour="black"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size=17),
        panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(size = 16, angle = 0, hjust=0),
        legend.title = element_blank(),
        legend.text = element_text(size=18),
        plot.margin = margin(0.8, 0.15, 1.2, 0.15, "cm"),
        legend.position = "top")+
  facet_grid(Group~., scales="free_y", space='free')+
  scale_x_continuous(trans='log10') +  
  xlab("log10(concentration)")+
  scale_alpha(guide = 'none')+
  guides(color=guide_legend("sample_category"), fill = "none")+
  scale_color_manual(values = c("#C77CFF", "#00BFC4", "#7CAE00"),
  labels = c('Marine biota', 'Freshwater', 'Sediment'))
  


ggsave("pnec23.png", pnecopp, width = 10, height = 18)

#, values = c("red", "blue", "grey"))
#  scale_colour_manual(labels = c("Biota", "Freshwater", "Sediment"), values = c("red", "blue", "grey"))
  
  #scale_fill_manual(values = c("red", "blue", "grey"))
  #scale_colour_manual(values = c("red", "blue", "grey"))


```