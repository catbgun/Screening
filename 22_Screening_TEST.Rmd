---
title: "Screening2022_First test"
output: html_document
date: "2023-09-11"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Functions* 
The following function will replace all "<LOD"
- har det no Ã¥ si om det er mellomrm mellom < og tallet? nei, tror ikke det
```{r}
#function to recognize "<LOD" and to replace with 0.5*LOD. The next step is to use this only for combinations of sample type and site with LOD >30
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for substitution
  as.numeric(v)
}
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "tidyr")
lapply(Packages, library, character.only = TRUE)
#trengs disse? "Rmisc", "tidyverse", "lubridate", "stringr",
```

Make sure that the short name of the molecules is at the bottom
Should be no zero values
```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO")
df <- read.table("V02_CLEAN_Results with format_Screening2022.txt", skip=5, header=TRUE, sep="\t", na.string=c(""))

#df <- read.table("V02_FINAL_Results_Screening2022_V04.txt", header=TRUE, sep="\t", na.string=c(""))
```

```{r from wide to long}
df_long <- gather(df, compound, value, ABT:LCCP, factor_key=TRUE)
df_long[complete.cases(df_long$value),]

df_longg <- subset(df_long, !is.na(value))
```

need to make column with frequency and then summary table.
will not rely in NA, but need to define >LOD.
Rather calculate mean later, after LOD has been replaced
```{r}
#by using mutate insytead of summarise we add the new columns to the old. consider un_group() at the end?
#df_longg$Medium_id <- revalue(df_longg$Medium_id, c("Particle"="Water_particle"))

df_longgg = df_longg%>%
  mutate(Medium_id2 = case_when(Medium_id %in% c("Water", "Water_filtered", "Water_particle", "Particle") ~ "Water",
                                Medium_id %in% c("Sediment","Sludge", "Granule") ~ "Solids",
                                Medium_id %in%c("Air", "Air_particles", "Dust") ~ "Air",
                                Medium_id %in%c("Biota") ~ "Biota"))

unique(df_longg$Medium_id)
unique(df_longgg$Medium_id2)
#if we want to categorise the types of sites additionally
#df_longggg = df_longgg%>%
#  mutate(Site_Category2 = case_when(Site_Category %in% c("Artificial grass pitch") ~ "Artificial grass pitch",
#                                Site_Category %in% c("Wastewater treatment plant_High","Wastewater treatment plant_Low") #~ "Wastewater treatment plant",
#                                Site_Category %in% c("Urban river_Alna") ~ "Urban river_Alna",
#                                Site_Category %in% c("Dental Clinic", "Furniture store", "Printing 3D") ~ "Urban #river_Alna",
#                                Site_Category %in% c("Tire collection site") ~ "Tire collection site",
#                                Site_Category %in% c("Private home") ~ "Private homes",
#                                Site_Category %in% c("Hotspot_outdoors") ~ "Private homes",
#                                Site_Category %in% c("Tunnel environment") ~ "Tunnel environment",
#                                Site_Category %in%c("Recipient_Freshwater", "Recipient_Marine") ~ "Recipient Biota"))


df_long_freq = df_longgg %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 
#df_long_freq$Medium_id <- revalue(df_long_freq$Medium_id, c("Water_particle"="Water (ng/L)"))
#to check frequency is ok
#write.csv(df_long_freq, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230914_TEST_filtercount.csv", row.names=FALSE)
```

Filter out observations with < 30 detection frequency
```{r Filter observations with low detection frequency}
#should be something saying something like LOD more than 30% should be marked as "<LOD/LOQ"

#df_long_filtered <- df_long_freq %>% 
# filter(if (det_frac < 30) value2 == Value else value2 == ) 
#  tail(1)
#df_long_filtered <- df_long_freq %>% 
#  group_by(Site_Category, compound, Medium_id2) %>% 
#  filter(if (y=="") x>3 else x<3) %>%  
#  filter(!(det_frac < 30))%>% 
#  ungroup()

#  v <- as.character(v)
#  isLimit <- grepl("<", v)

#filter observations with < 30 detection frequency
df_long_filtered <- df_long_freq %>% 
  group_by(Site_Category, compound, Medium_id) %>% 
  filter(!(det_frac < 30))%>% 
  ungroup()

#write.csv(df_long_filtered, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230914_TEST_filtercount_filter.csv", row.names=FALSE)
```


```{r Calculate 0.5xLOD}
df_long_X <- cbind(df_long_filtered[,c(1:3,8:10, 15, 17:20)], apply(df_long_filtered[,16, drop=F],2, dLimity))

#write.csv(df_long_X, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230914_TEST_filtercount_filter_LOD.csv", row.names=FALSE)
```

Calculate mean
```{r}
#remove NAs, should not be NAs here, but still missing data from NILU
df_long_Y <- df_long_X[!is.na(df_long_X$value),] 
df_final = df_long_Y %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(mean = mean(value, na.rm = TRUE))%>% 
  ungroup()
```

add molecule grouping
```{r}
#total of 62 compounds, correct? are the groupings correct? there is a difference between the excel and the word files
df_finalx = df_final%>%
  mutate(m_group = case_when(compound %in%c("LCCP") ~ "Chlorparaffins",
                             compound %in%c("CTC_CTA", "BCPS", "isoTAC", "TAC") ~ "Semi-volatiles",
                             compound %in% c("ABT", "BTSA", "MTBT", "PhBT","OHBT", "MBT", "CPPD", "X6PPDq", "DPPD", "DNPD", "IPPD", "X77PD", "X6PPD", "X7PPD", "X44PD", "MTDID", "NDPD", "MPAMS", "PPPA", "BOPA","TMMAT","DPG","TMQ","TAI","TAOT") ~ "Rubber",
                             compound %in% c("BPSE", "BPAE",  "4_4_ADP", "TMBP", "OH_BPA",	"44_BPS2",	"BIS", "TMC") ~ "Bisphenols",
                             compound %in%c("TCM",	"DCM",	"TCE",	"PCE",	"CCl4",	"DBM") ~ "Volatiles",
                             compound %in%c("L6",	"L7",	"L8",	"L9",	"L10") ~ "Siloxanes",
                          compound %in% c("Fipronil","Cyhalothrin", "Amitryptyline", "Fexofenadine","Indoxacarb") ~ "Pesticides_Pharmaceuticals",
                          compound %in%c("OP", "12_PFECA",	"112_PFECA",	"1112_PFECA",	"11112_PFECA",	"13_PFECA") ~ "Surfactants including PFAS",
                          compound %in%c("BP_8", "4_HBP") ~ "UV-additives"))

#write.csv(df_finalx, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230914_TEST_final.csv", row.names=FALSE)

#is.na(df_finalx$m_group)
```

```{r fix names}
df_finalx$compound <- revalue(df_finalx$compound, c("X6PPD"="6PPD"))
df_finalx$compound <- revalue(df_finalx$compound, c("X6PPDq"="6PPD-q"))
df_finalx$Site_Category <- revalue(df_finalx$Site_Category, c("Urban river_Al"="Urban river"))

df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Water"="Water (ng/L)"))

df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Water_filtered"="Water filtered (ng/L)"))
df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Water_filtered"="Water filtered (ng/L)"))


df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Granule"="Granule (g/g)"))
df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Sediment"="Sediment (g/g)"))
df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Sludge"="Sludge (g/g)"))

df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Air_particles"="Particles (ng/m3)"))
df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Dust"="Dust (ng)"))
df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Air"="Sludge (ng/m3)"))

df_finalx$Medium_id <- revalue(df_finalx$Medium_id, c("Biota"="Biota (ng/g, w.w.)"))

```

Could it be possible to have those <LOD 30% marked as < LOD and being green? 
Below we have the plot in ggplot
```{r}
#library(scales) # for muted function
chl <- subset(df_finalx, m_group == "Chlorparaffins")
sem <- subset(df_finalx, m_group == "Semi-volatiles")
rub <- subset(df_finalx, m_group == "Rubber")
bis <- subset(df_finalx, m_group == "Bisphenols")
vol <- subset(df_finalx, m_group == "Volatiles")
sil <- subset(df_finalx, m_group == "Siloxanes")
pest <- subset(df_finalx, m_group == "Pesticides_Pharmaceuticals")
surf <- subset(df_finalx, m_group == "Surfactants including PFAS")
UV <- subset(df_finalx, m_group == "UV-additives")

unique(chl$Medium_id)
```

1) Group Chlorparaffins
- since there are few, can we have water, air aand soluds
- NOT SURE HOW TO
```{r Heatmap table chl}
#WATER
 ggplot(subset(chl, compound%in% c("LCCP")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water, Air, and Solids") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

#AIR
 ggplot(subset(chl, Medium_id2%in% c("Air")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 4)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Air") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
 
#SOLIDS  
ggplot(subset(chl, Medium_id2%in% c("Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Solids") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```
HOW to make the heatmap table sizes the same

https://stackoverflow.com/questions/58830318/setting-specific-tile-size-for-geom-tile-between-two-graphs

2) Group RUBBER
  - water
  - solids
  - air
```{r Heatmap table RUBBER}
unique(rub$Medium_id2)

ggplot(subset(rub, Medium_id2%in% c("Water")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

 #SOLIDS
 ggplot(subset(rub, Medium_id2%in% c("Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Solids") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
 
 #AIR
 ggplot(subset(rub, Medium_id2%in% c("Air")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Air") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```

3) Bisphenols
```{r BISPHENOLS}
unique(bis$Medium_id2)

 #AIR AND SOLIDS
 ggplot(subset(bis, Medium_id2%in% c("Water", "Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water and Solids") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

 #AIR
 ggplot(subset(bis, Medium_id2%in% c("Air")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Air") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```

4) VOlatile substances
```{r VOLATILES}
unique(vol$Medium_id2)
#WHY IS sludge categorised as AIR??!
#Water
ggplot(subset(vol, Medium_id2%in% c("Water", "Air", "Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))


```

5) SIloxanes
```{r SILOXANES}
unique(sil$Medium_id2)

ggplot(subset(sil, Medium_id2%in% c("Water", "Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water and Solids") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
 
 #AIR AND BIOTA
 #something wrong with the categories, sludge in commercial building??
ggplot(subset(sil, Medium_id2%in% c("Air", "Biota")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Air and Biota") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```

6) Pesticides and Pharmaceuticals
```{r pest}
unique(pest$Medium_id2)

ggplot(subset(pest, Medium_id2%in% c("Water", "Solids")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

```

7) Surfactants including PFAS
```{r Surfactants including PFAS}
unique(surf$Medium_id2)

#WATER
ggplot(subset(surf, Medium_id2%in% c("Water", "Solids", "Air")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water, Solids, and Air") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```

9) UV-additives
```{r}
unique(UV$Medium_id2)

ggplot(subset(UV, Medium_id2%in% c("Water", "Solids", "Air", "Biota")), aes(x=Medium_id, y=compound, fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 5)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(0,100), na.value = "white")+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 17,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=15),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(1, 0.3, 0.3, 0.3, "cm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,100,10),
        strip.text.x = element_text(size = 16),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water, Solids,  Air, and Biota") + 
  theme(legend.title=element_text(size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```












Illustrating differebces between e.g. low and high purification wastewater

```{r differences in wastewater treatment}

class(rub$detect_frac)
rub <- subset(df_finalx, m_group == "Rubber")
pest <- subset(df_finalx, m_group == "Pesticide_Pharmaceutical")
bis <- subset(df_finalx, m_group == "Bisphenols")
surf <- subset(df_finalx, m_group == "Surfactants")

ggplot(subset(df_finalx, Site_Category2%in% c("Wastewater treatment plant")), aes(y=mean, x=compound))+
  geom_col()+
  facet_grid(Medium_id~Site_Comment)

  
facet_grid(Medium_id~.)
  geom_tile(aes(fill = det_frac), colour="gray")+  # background colours are mapped according to the value column
  geom_text(aes(label = round(mean, 0)), color = "white", size = 4)+ # write the values
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50)+  # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 12,face = "bold"),
        plot.title = element_text(size=20,face="bold"),
        axis.text.y = element_text(size = 12,face = "bold")) +
  ggtitle("Rubber in water") + 
  theme(legend.title=element_text(face="bold", size=14)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency")
  facet_grid(Medium_id2~.)
```




















```{r}
library(dplyr)
#is the following correct?
df_filteredX = df_filtered %>%
  group_by(Site_Category, compound) %>%
  summarize(mean = mean(value, na.rm = TRUE),
            nacount = (sum(is.na(value))),
            detect_frac = ((sum(!is.na(value)))/((sum(!is.na(value)))+nacount)*100), 
            .groups="keep")

class(df_filteredX$mean)

```
















```{r making table}
#if(!require(devtools)) install.packages("devtools")
#devtools::install_github("cardiomoon/ztable")
library(ztable)
library(moonBook)

x=table(df_filtered$Dx,acs$smoking)
x

mycolor=gradientColor(low="yellow",mid="orange",high="red",n=6,plot=TRUE)

#subset only those needed
#from long to wide
data_wide <- spread(df_filtered, compound, value)
data_wide2 <-data_wide[,c(2,9, 15:21)]

dfx2 <- na.omit(dfx)

dfx3 <- unlist(dfx)


dfx_wide <-spread(dfx, compound, value)

class(dfx$v)
symm = T
dfx_wide2 <- na.omit(dfx_wide)
ztable(head(dfx_wide2[2:8])) %>% 
    makeHeatmap %>%
    print(caption="Table 6. Heatmap table with user-defined palette")


```















```{r filter}
library(magrittr)

df_long2 <- df_long %>%
  filter(Group="Rubber")%>%
  group_by(Compound)%>%
  filter(Group="Rubber")%>%
  aggregate(d[, 3:4], list(d$Name), mean)


adf %>%
  add_count(x) %>% 
  filter(n %in% tail(sort(unique(n)),2)) %>% 
  arrange(desc(n))

```

```{r}

```

First make summary
First make a table
Then make heatmap colouring https://cran.r-project.org/web/packages/ztable/vignettes/heatmapTable.html
```{r try to make heatmap table}
install.packages("ztable")
library(ztable)

df_long2 <- df_long[,14:15]

x=table(acs$Dx,acs$smoking)

ztable(head(df_long2)) %>% 
    makeHeatmap(palette="YlOrRd",cols=c(14, 15),margin=2) %>%
    print(caption="Table 8. Columnwise heatmap table")
```



```{r Filter out obs detect freq < 30%}
#df_long2 <- df_long[!is.na(df_long$value),] #there should be no NAs
class(df_long2$value)

#Need to deal with the <LODs. For calculating average we use 0.5xLOD, but only when detection frequency is >30%. Per sample type and category.
n_samples  <- n_distinct(df_long_freq$Site_Category, df_long_freq$Medium_id) # total number of samples

df_long_filtered <- df_long_freq %>% 
  group_by(compound, value) %>% 
  filter(!((n_distinct(Site_Category, Medium_id)/n_samples < 0.50)& (value > 0)))%>% 
  ungroup()

#Need some way to filter out the >30% detection frequency, if >30 perform calculation, if below keep 

#Filter those with <LOD

df_long_X <- cbind(df_long_filtered[,c(1:3,9:10, 14, 16:18)], apply(df_long_filtered[,15, drop=F],2, dLimity))
#is.na(df_long_X$value)
#unique(df_long_X$value)
#when converted to numeric the "<LOD" are converted to NAs. Must make sure that these are included in the rate calculations below. They might be which could solve the problem
class(df_long_X$value)
#remove NAs, should not be NAs here, but still missing data from NILU
df_long_Y <- df_long_X[!is.na(df_long_X$value),] 
#nrow(df_long_X)
```



ilter out those molecules with greater than 50% detection frequency in at least two independent sample types/environmental compartments

```{r filter observations in dample type and environment with obs mor}
#https://stackoverflow.com/questions/47536406/filter-based-on-percentage-of-samples-with-an-observation-in-dplyr
#n_samples  <- n_distinct(df_long2$Site_Category, df_long2$Medium_id) # total number of samples
#n_samples

#check if the filtering is performed per compound!!!
#df_filtered <- df_long2 %>% 
#  group_by(compound, value) %>% 
#  filter(!((n_distinct(Site_Category, Medium_id)/n_samples > 0.50)& (value > 0)))

#nrow(df_filtered)

#write.csv(df_filtered, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230912_TEST_filtercount.csv", row.names=FALSE)

```
