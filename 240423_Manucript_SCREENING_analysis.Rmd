---
title: "240423_Manucript_SCREENING_analysis"
output: html_document
date: "2024-04-23"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
*Functions* 
The following function will replace all "<LOD"
- har det noe å si om det er mellomrom mellom < og tallet? nei, tror ikke det
```{r}
#function to recognize "<LOD" and to replace with 0.5*LOD. The next step is to use this only for combinations of sample type and site with LOD >30
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for substitution
  as.numeric(v)
}
```

```{r}
get_box_stats <- function(y, upper_limit = max(df$mpg) * 1.15) {
  return(data.frame(
    y = 0.95 * upper_limit,
    label = paste(
      "n =", length(y), "\n"
      
    )
  ))
}

#"Mean =", round(mean(y), 2), "\n",
#      "Median =", round(median(y), 2), "\n"
```


```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "tidyr", "egg", "reshape2", "forcats")
lapply(Packages, library, character.only = TRUE)
#trengs disse? "Rmisc", "tidyverse", "lubridate", "stringr",
```


The file that is now uploaded has no mean or frequency of detection calculated. But only the sompounds of interest are included. 

```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO")
#df <- read.table("240110_MS_Screening.txt", header=TRUE, sep="\t", na.string=c(""))
#remember to resave from csv to txt
df <- read.table("240621_MS_Screening.txt", header=TRUE, sep="\t", na.string=c(""))

length(unique(df$compound)) #should be 22
#ft <- subset(df, Site_Category=="Artificial grass pitch")
#ft1 <- subset(ft, Medium_id == "Water, total")
#ft2 <- subset(ft1, Site_name == "Valle Hovin East")

```

To decide on % detection frequency of not
- is it possible to have the same criteria for the different sites? Perhaps start with the sources
- Site_Category, compound, and Medium_id

- What do we want for the tables/figures? When only e.g. n=3 it might be best with average of those observed and number of observations?
```{r Fix}
#replace tunnel environment with trafficked road
df$Site_Category <- revalue(df$Site_Category, c("Tunnel environment" = "Trafficked road"))
unique(df$Site_Category)

#Smestaddammen should not be trafficked road category, but instead recipient
df1 <- df %>% mutate(Site_Category = replace(Site_Category, which(Site_Category == "Trafficked road" & Site_name == "Smestaddammen"), "Urban pond"))

#remove the following sample which was not a true man hole sediment sample
df2 <- df1 %>% 
  filter(!(Site_name == "Valle Hovin East" & Medium_id == "Sludge (ng/g, d.w.)"))

```


```{r hot spots}
#hs <- subset(df, Site_Category == c("Trafficked road", "Artificial grass pitch"))

#here calculates detection frequency and n for all, but might not be the correct criteria for all sites
df_freq = df2 %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(lodcount = sum(lengths(regmatches(value, gregexpr("<", value)))),
            n = (length(value)),
            det_frac = (100-(lodcount/n)*100))%>%
  ungroup() 

write.csv(df_freq, "240621_MS_TEST.csv", row.names=FALSE)
```

## Trafficked road
- lag en boksplot for hver medium_id
https://www.appsilon.com/post/ggplot2-boxplots

```{r create figure looking into the tunnel environment}
unique(road$Medium_id)
# unique(road$Medium_id) [1] "Water, filtered (ng/L)"  "Water, particles (ng/L)" "Sludge (ng/g, d.w.)"     "Air, particles (ng/m^3)"

road <- subset(df_freq, Site_Category == "Trafficked road")
road_water <- subset(road, Medium_id == c("Water, filtered (ng/L)", "Water, particles (ng/L)"))
road_air <- subset(road, Medium_id == c("Air, particles (ng/m^3)"))
road_slud <- subset(road, Medium_id == c("Sludge (ng/g, d.w.)"))

#geom_col(position="dodge")

#WATER
road_water_dis <- subset(road_water, Comment_location == c("Treated discharge"))
ggplot(road_water_dis, aes(y=as.numeric(value), x=compound, fill=Site_Comment))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")
  facet_grid(Site_Comment~ ., scales="free", space='free_x')+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-5, hjust=0.5)
    
geom_text(data = road_air, aes(x = variable, y = quant, label = variable), size = 10)

#SLUDGE
ggplot(road_slud, aes(y=as.numeric(value), x=compound, fill=Comment_condition))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Comment_location~ ., scales="free", space='free_x')+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-5, hjust=0.5)
    
geom_text(data = road_air, aes(x = variable, y = quant, label = variable), size = 10)

#AIR
ggplot(road_air, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-8, hjust=0.5)
    geom_text(data = road_air, aes(x = variable, y = quant, label = variable), size = 10)
  
    #facet_grid(Site_name~ ., scales="free", space='free_x')
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=0, hjust=0.5)

#hjust = 0.5, vjust = 0.9
head(tunnel)
unique(df$Medium_id)
unique(df$Site_Category)
```

## Artificial grass pitch
- granulate different between indoor and outood? separate: Site_Comment

```{r looking into the artificial grass pitch samples}
footb <- subset(df_freq, Site_Category == "Artificial grass pitch")
unique(footb$Medium_id)
# "Water, total (ng/L)"     "Granule (ng/g, w.w.)"    "Sludge (ng/g, d.w.)"    
# "Air, particles (ng/m^3)"

#GRANULATE
gran <- subset(footb, Medium_id == "Granule (ng/g, w.w.)")
air <- subset(footb, Medium_id == "Air, particles (ng/m^3)")
wat <- subset(footb, Medium_id == "Water, total (ng/L)")

ggplot(gran, aes(y=as.numeric(value), x=compound, fill=Comment_location))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-8, hjust=0.5)+
  facet_grid(Site_name ~ ., scales="free", space='free_x')
    
#AIR
ggplot(air, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-8, hjust=0.5)+
  facet_grid(Site_name ~ ., scales="free", space='free_x')
    
#WATER
ggplot(wat, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-8, hjust=0.5)+
  facet_grid(Site_name ~ ., scales="free", space='free_x')

```

### Look into patterns across sites
Air: samples from trafficked road, indoor football field and urban park. Are they the same type? Particle or air?
```{r Air}
unique(df_freq$Medium_id)
#"Water, total (ng/L)"     "Granule (ng/g, w.w.)"    "Sludge (ng/g, d.w.)"     "Sediment (ng/g, d.w.)"   "Water, filtered (ng/L)"  "Water, particles (ng/L)"
# [7] "Biota (ng/g, w.w.)"      "Dust (ng/g, w.w.)"       "Air (ng/m^3)"            "Air, particles (ng/m^3)"

Air_all <- subset(df_freq, Medium_id == c("Air, particles (ng/m^3)"))
#Air_all_a <- subset(df_freq, Medium_id == c("Air (ng/m^3)" )) #we do not include air measurements since we dont have those from the "hot spot" locations. 

#barplot with number of observation and faceted by site
ggplot(Air_all, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_point(size=3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-6, hjust=0.5)+
  facet_grid(Site_Category ~ ., scales="free", space='free_x')
```

Water
```{r}
Wat_all <- subset(df_freq, subset = Medium_id %in% c("Water, total (ng/L)", "Water, filtered (ng/L)", "Water, particles (ng/L)"))
#unique(Wat_all$Medium_id)
Wat_all2 <- subset(Wat_all, Site_Category !="Tyre collection site")

#Make selection from tunnel and select only the discharged water from Bekkelaget

ww <- subset(Wat_all2, Site_Category == "Wastewater treatment plant")

ggplot(Wat_all2, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-6, hjust=0.5)+
  facet_grid(Site_Category ~ .,  space='free_x')

ggplot(ww, aes(y=as.numeric(value), x=compound, fill=Comment_condition))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-6, hjust=0.5)+
  facet_grid(Comment_season ~ .,  space='free_x')

```


Sludge and sediment
```{r}
sol_all <- subset(df_freq, subset = Medium_id %in% c("Sludge (ng/g, d.w.)", "Sediment (ng/g, d.w.)"))
#unique(sol_all$Medium_id)
sol_all2 <- subset(sol_all, Site_Category !="Tyre collection site")

#Make selection from tunnel and select only the discharged water from Bekkelaget
ww_s <- subset(sol_all2, Site_Category == "Wastewater treatment plant")

ggplot(sol_all2, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-3, hjust=0.5)+
  facet_grid(Site_Category ~ .,  space='free_x')

ggplot(ww_s, aes(y=as.numeric(value), x=compound, fill=Comment_condition))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-6, hjust=0.5)+
  facet_grid(Comment_season ~ .,  space='free_x')

```

Biota
```{r}
bio_all <- subset(df_freq, subset = Medium_id %in% c("Biota (ng/g, w.w.)"))
#unique(df_freq$Medium_id)
sol_all2 <- subset(sol_all, Site_Category !="Tyre collection site")

#Make selection from tunnel and select only the discharged water from Bekkelaget
ww_s <- subset(sol_all2, Site_Category == "Wastewater treatment plant")

ggplot(bio_all, aes(y=as.numeric(value), x=compound, fill=Medium_id))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-3, hjust=0.5)+
  facet_grid(Comment_condition ~ ., scale="free", space='free_x')

ggplot(ww_s, aes(y=as.numeric(value), x=compound, fill=Comment_condition))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  stat_summary(fun.data = get_box_stats, geom = "text", vjust=-6, hjust=0.5)+
  facet_grid(Comment_season ~ .,  space='free_x')

```





###Heatmap plot for articifial grass pitch
- average value must be recalculated, without 0.5x LOD (?)
- we need the number of observations somewhere


THE DATA WE HAVE DOES NOT CONTAIN <LOD AND THIS IS NEEDED! WE NEED A NEW DATAFILE

```{r Calculating average}
footb2 = footb1 %>%
  group_by(compound, Medium_id) %>%
  mutate(meanx2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#provide detection frequency as well as number of observations
footb2 <- footb1  %>%
  group_by(compound, Medium_id) %>%
  mutate(lodcountx = sum(lengths(regmatches(value, gregexpr("<", value)))),
            nx = (length(value)),
            det_fracx = (100-(lodcount/n)*100))%>%
  ungroup() 

#take a look in excel


#how should the mean/median be calculated?

```




```{r HEATMAP PLOT}

#NEEDS TO BE EDITED
df_finalzz$meanx <- as.numeric(df_finalzz$meanx)

#Table for tyre collectoin site with all sample types
ggplot(subset(df_finalzz, Site_Category%in% c("Tyre collection site")), aes(x=Medium_id, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black") + # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(0.8, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
```





```{r}

```


FOR THE MANUSCRIPT. 
- do we want to change the 30% detection frequency criteria?
- do we want to treat obs < LOD differently?
- sjekk hvordan gjennomsnittet blir beregnet

Focus on:"LCCP","BCPS", "OH-BPA","BIS TMC","ABT","BTSA","MTBT", "PhBT", "OHBT","MBT","CPPD","6PPD-q", "DPPD","IPPD","6PPD","7PPD","BOPA","TMMAT","DPG","TMQ", "isoTAC","TAC"

NEW groupings, 29/9
```{r Groupings}
df_finalz1 = df%>%
  mutate(m_group = case_when(compound %in%c("LCCP") ~ "Long-chain chlorinated paraffins",
                             compound %in%c("BPSE", "BCPS", "OH-BPA", "BIS TMC") ~ "Bisphenols",
                             compound %in%c("ABT", "BTSA", "MTBT", "PhBT", "OHBT", "MBT", "CPPD", "6PPD-q", "DPPD", "IPPD",  "6PPD", "7PPD", "BOPA", "TMMAT", "DPG","TMQ", "isoTAC", "TAC") ~ "Rubber related"))

```

Below we have the plot in ggplot
```{r}
df_finalzx <- df_finalz1 %>% 
  mutate(compound = factor(compound, levels = c("OH-BPA", "BIS TMC", "LCCP", "ABT", "BTSA", "MTBT", "PhBT", "OHBT", "MBT", "CPPD", "DPPD", "IPPD", "6PPD", "6PPD-q", "7PPD", "BOPA", "TMMAT", "DPG", "TMQ", "isoTAC", "TAC", "BCPS")))
#unique(df_finalz1$compound)

df_finalzz <- df_finalzx %>% 
  mutate(Site_Category = factor(Site_Category, levels = c("Tyre collection site",
                                                          "Tunnel environment",
                                                          "Trafficked road",
                                                          "Artificial grass pitch",  
                                                          "Wastewater treatment plant", 
                                                          "Urban river", 
                                                          "Urban park",
                                                          "Private home", 
                                                          "Commercial building", 
                                                          "Recipient")))

unique(df_finalzx$Site_Category)
#    "LCCP","BCPS", "OH-BPA","BIS TMC","ABT","BTSA","MTBT", "PhBT", "OHBT","MBT","CPPD","6PPD-q", #"DPPD","IPPD","6PPD","7PPD","BOPA","TMMAT","DPG","TMQ", "isoTAC","TAC")))


#library(scales) # for muted function
#chl <- subset(df_finalzzzz, m_group == "Long-chain chlorinated paraffins")
#bis <- subset(df_finalzzzz, m_group == "Bisphenols")

#unique(chl$Medium_id)
#sigfig <- function(vec, digits){return(gsub(\\.$, "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
#  }
```

```{r Test to set desired number of digits}
sigfig <- function(vec, digits){
  return(gsub("\\.$", "", formatC(signif(vec,digits=digits), digits=digits, format="fg", flag="#")))
}
#geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 2))), color = "white", size = 5)+
#geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 3))), color = "white", size = 5)
#geom_text(aes(label=ifelse(is.na(meanx), "", round(meanx, digits=3))), color = "white", size = 5)
```

HEATMAP TABLE PLOT
```{r heatmap table}
#unique(bis$compound)
#class(df_finalzz$meanx)
df_finalzz$meanx <- as.numeric(df_finalzz$meanx)

#Table for tyre collectoin site with all sample types
ggplot(subset(df_finalzz, Site_Category%in% c("Tyre collection site")), aes(x=Medium_id, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black") + # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(0.8, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

#WATER
ggplot(subset(df_finalzz, Medium_id2%in% c("Water")), aes(x=Medium_id, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black") + # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
 scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(0.8, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Water") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

 #AIR
ggplot(subset(df_finalzz, Medium_id2%in% c("Air")), aes(x=Medium_id, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
     scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(0.8, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Air") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))
 
ggplot(subset(df_finalzz, Medium_id2%in% c("Solids", "Biota")), aes(x=Medium_id, y=fct_rev(compound), fill=det_frac)) +
  geom_tile(aes(fill = det_frac), colour="black")+  # background colours are mapped according to the value column
  geom_text(aes(label=ifelse(is.na(meanx), "", sigfig(meanx, 1))), color = "white", size = 5)+
  scale_fill_gradient2(low = "green", 
                       mid = "orange", 
                       high = "red",
                       midpoint = 50,
                       breaks=c(0,50,100), limits=c(30,100), na.value = "#8aab91")+  # determine the colour
   theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(), 
        panel.grid.major.y=element_blank(), 
        panel.grid.minor.y=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=90, hjust = 1,vjust=1,size = 15,colour="black"),
        plot.title = element_text(size=18,colour="black", vjust = 1, face="bold"),
        axis.text.y = element_text(size = 17, colour="black"),
        legend.text=element_text(size=13),
        axis.line.x = element_line(color="black", linewidth = 1),
        axis.line.y = element_line(color="black", linewidth = 1),
        axis.ticks = element_line(color="black", linewidth=1),
        legend.position =c(0.75, 1.11),
        legend.direction = "horizontal",
        plot.margin = margin(0.8, 0.2, 0.15, 0.15, "cm"), #top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(10,10,140,10),
        strip.text.x = element_text(size = 15),
        panel.spacing.x = unit(0.2, "lines")) +
  ggtitle("Solids including Biota") + 
  theme(legend.title=element_text(size=12)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Detection frequency (%)")+
  facet_grid(~Site_Category, scales="free", labeller = label_wrap_gen(width=2))

bissx <- egg::ggarrange(bis1, bis2)

ggsave("water.png", w, width = 10, height = 8)
ggsave("airc.png", a, width = 10, height = 8)
ggsave("solidbiota.png", sb, width = 10, height = 8)
```


PNEC FIGUE
The following compounds: LCCP, BCPS, isoTAC, TAC, BTSA, OHBT, 6PPD,6PPD-q,DPPD,IPPD,TMQ,TMMAT,DPG, BIS TMC,,DBM,L6,L7,L8,BP_8,4_HBP
```{r Making the PNEC Figure}
#df_finalzzc <- df_finalzz %>% 
#  mutate(compound = factor(compound, levels = c("11112-PFECA", "1112-PFECA", "112-PFECA", #"12-PFECA", "13-PFECA", "4,4-ADP", "44-BPS2", "44-PD", "4-HBP", "6PPD", "6PPD-q", "77PD", "7PPD", #"ABT",  "Amitriptyline", "BCPS", "BIS TC", "BOPA", "BP-8", "BPAE", "BPSE", "BTSA","CCl4", "CPPD", #"CTC/CTA", "Cyhalthrin", "DBM", "DCM", "DNPD", "DPG", "DPPD", "Fexofenadine", "Fipronil", #"Indoxacarb", "IPPD", "isoTAC", "L10", "L6", "L7", "L8", "L9", "LCCP", "MBT", "MPAMS", "MTBT",  #"MTDID", "NDPD", "OH-BPA", "OHBT", "OP", "PCE", "PhBT", "PPPA", "TAC", "TAI", "TAOT", "TCE", #"TCM", "TMBP", "TMMAT", "TMQ")))

#pnec <- subset(df_finalzzc, compound%in% c("LCCP", "CTC/CTA", "BCPS", "isoTAC", "BTSA", "OHBT", #6PPD", "6PPD-q", "DPPD", "IPPD", "TMQ", "TMMAT", "DPG", "44-BPS2", "BIS-TMC", "TAOT", "DCM", #TCE", "PCE", "CCl4", "L6", "L7", "L8",  "BP-8", "4-HBP", "OP", "Amitriptyline", "Fexofenadine"))
##unique(pnec$compound)  #sjekk at alle er med. Noen endrer navn i R ved lesing

#følgende gjør om alle "< LOD" observasjoner til NA slik at de ikke inkluderes som minimumsverdi
df_finalzz$value2 <- as.numeric(df_finalzz$value)
pnec <- df_finalzz %>% drop_na(value2)

#filter out max an min values for each category. Wich categories to choose? 
pnec_max_minx <- pnec %>%
  group_by(compound, Medium_id2) %>%
  mutate(Min = min(value2), Max = max(value2))
unique(pnec$Medium_id2)

#Make new categories to match the PNEC categories of freswater, sediment og biota
#not using air values here
pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")

pnec_max_min2 <- pnec_max_miny%>%
  mutate(sample_category = case_when
         (Medium_id2 %in% c("Water") ~ "Freshwater",
          Medium_id2 %in% c("Solids") ~ "Sediment",
          Medium_id2 %in% c("Biota") ~ "Biota"))

nrow(pnec_max_min2)
unique(pnec_max_min2$sample_category)
#Laste opp fil med PNEC verdier. Laget fra info i word
#condition and sample category
# short and compound
dx <- read.table("PNEC3.txt", header=TRUE, sep="\t", na.string=c(""))


#Calculate to the correct abbreviations
dx$Freshwater2 <- dx$Freshwater *1
dx$Sediment2 <- dx$Sediment *1
dx$Biota2 <- dx$Biota*1

dx_long <- gather(dx, sample_category, limit, Freshwater2:Biota2, factor_key=TRUE)
dx_long$compound <- revalue(dx_long$compound, c("6PPDq"="6PPD-q"))
dx_long$compound <- revalue(dx_long$compound, c("BIS_TMC"="BIS TMC"))

#one may have wrong class
pnec_max_min4 <- as.data.frame(pnec_max_min2)
#subsetting to keep only those with match
pnec_max_min4$sample_category <- revalue(pnec_max_min4$sample_category, c("Freshwater"="Freshwater2", "Biota"="Biota2", "Sediment"="Sediment2"))

pnec_max_min5 <- subset(pnec_max_min4, sample_category%in% c("Freshwater2", "Sediment2", "Biota2"))

#MERGE. Til pnec_max_min2 skal vi fra dx legge til alle kolonner ved å matche 
dx2 <- merge(x=pnec_max_min5,y=dx_long, by.x=c(as.character("compound"), as.character("sample_category")),
             all.x=TRUE)

#ARE THRER wrong abbreviations for pnec??

write.csv(dx2, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/231003_TEST_pnec.csv", row.names=FALSE)
```

Må rydde opp i følgende:
- fjern de som enten ikke har måling eller PNEC i gjeldende prøvetamtriks
- sorter stoffene etter stoffgruppe
- legg til stoffgruppenavn

- i figuren ser det ut som at vi mister noen prøvetyper, f eks sediment og biota. 

```{r Cleaning up before plotting}
#remove duplicate rows before plotting
dx3 <-dx2 %>% 
  distinct(Min, Max, compound, sample_category, .keep_all = TRUE)

#sett rekkefølgen til molekylgruppene hvis ikke alle skal med. Altså, dersom kun de med PNEC skal med. Må fjerne de som ikke er med i de 21 i artikkelen. 
#dx4 <- dx3 %>% 
#  mutate(compound = factor(compound, levels = c("44-BPS2", "BCPS", "DCM", "PCE", "TCM", "LCCP", "Amitriptyline", "CTC/CTA","Fexofenadine",
#                                                "6PPD", "6PPD-q", "BTSA", "DPG", "DPPD", "IPPD", "isoTAC", "OHBT", "TAOT", "TMMAT", "TMQ", #"L6", "L7", "L8", "OP", "4-HBP", "BP-8")))

```

```{r PNEC plot}
 ggplot(dx3, aes(y=fct_rev(compound), x=value2, xmin = Min, xmax=Max, colour = sample_category))+ 
  geom_linerange(size=2, aes(colour = sample_category, alpha=1), position = position_dodge2(width = 0.7))+
  geom_point(aes(x=limit, fill = sample_category),  size=5, shape=18, position = position_dodge2(width = 0.7))+
  scale_x_continuous(trans='log10') +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1,vjust=1,size = 14,colour="black"),
        axis.text.y = element_text(size = 15,colour="black"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size=15),
        panel.spacing = unit(0, "lines"), 
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(size = 14, angle = 0, hjust=0),
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        plot.margin = margin(0.8, 0.15, 1.2, 0.15, "cm"),
        legend.position = "top")+
  facet_grid(m_group~., scales="free_y", space='free')+
  xlab("log10(concentration)")+
  scale_alpha(guide = 'none')+
  guides(color=guide_legend("sample_category"), fill = "none")+
  scale_color_manual(values = c("#C77CFF", "#00BFC4", "#7CAE00"),
  labels = c('Biota', 'Freshwater', 'Sediment'))

ggsave("pnec.png", pnec, width = 7, height = 9.3)

#, values = c("red", "blue", "grey"))
#  scale_colour_manual(labels = c("Biota", "Freshwater", "Sediment"), values = c("red", "blue", "grey"))
  
  #scale_fill_manual(values = c("red", "blue", "grey"))
  #scale_colour_manual(values = c("red", "blue", "grey"))


```


# Exploring site specific contamination patterns

For the different aspects, the mean must be calculated in slightly different ways. This is first done here
```{r}
class(df_finalzz$plotting)

df_finalzz$plotting <- as.numeric(df_finalzz$plotting)

enviA = df_finalzz %>%
  group_by(Site_Category, compound, Medium_id2) %>%
  mutate(meanx_season = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

enviW = df_finalzz %>%
  group_by(Site_Category, compound, Medium_id2) %>%
  mutate(meanx_season = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#kilde = df_finalzz %>%
#  group_by(Site_Category, compound, Medium_id) %>%
#  mutate(meanx_season = mean(plotting, na.rm = TRUE))%>% 
#  ungroup()

```

1) Substances in air
Compare substances measured in trafficked air, urban park, private home, and commercial buildings
```{r plotting in air}
#testing grouping below x axis
envixx4 <- subset(envixx2x, !is.na(meanx))

#need to remove tyre collection site
enviA2 <- subset(enviA, !Site_Category == "Tyre collection site")
enviA3 <- subset(enviA2, !Site_Category == "Wastewater treatment plant")

#  scale_fill_manual(values=c("dodgerblue3", "dodgerblue3", "dodgerblue3", "#E69F00"))
ggplot(subset(enviA3, Medium_id2%in% c("Air")), aes(y=meanx, x=compound, fill=Site_Category))+
  geom_col(position="dodge")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Site_Category~m_group, scales="free", space='free_x')
```

2) Substances in water
Compare substances measured in tunnel, artificial grass pitch, urban river and wastewater treatment
- make smestaddammen an independent category
```{r}
ggplot(subset(enviA2, Medium_id2%in% c("Water")), aes(y=meanx, x=compound, fill=Site_Category))+
  geom_col(position="dodge")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Site_Category~m_group, scales="free", space='free_x')

```

## Road versus football field
```{r road versus soccer field}
#tidy up the medium-categories prior to calcualtions and plotting
kilde <- subset(df_finalzz, Site_Category == c("Tunnel environment", "Artificial grass pitch", "Trafficked road"))

#Take Smestaddammen out from the road traffic
kildex <- subset(kilde, Site_name != c("Smestaddammen"))

unique(kildex$Site_name)

kilde2 <- subset(kildex, kildex$Medium_id %in%c("Water, total (ng/L)", "Sludge (ng/g, d.w.)", "Water, particles (ng/L)", "Water, filtered (ng/L)", "Air, particles (ng/m^3)"))

kilde2$Site_Category <- revalue(kilde2$Site_Category, c("Tunnel environment"="Road environment"))
kilde2$Site_Category <- revalue(kilde2$Site_Category, c("Trafficked road"="Road environment"))

kilde2$meanxx <- as.numeric(kilde2$meanx)

kilde3 <- subset(kilde2, !is.na(meanxx))

kilde4 = kilde3 %>%
  group_by(Site_Category, compound, Medium_id2) %>%
  mutate(meanx_season = mean(meanxx, na.rm = TRUE))%>% 
  ungroup()

ggplot(subset(kilde4, Site_Category %in% c("Road environment", "Artificial grass pitch")), aes(y=as.numeric(meanx_season), x=compound, fill=Site_Category))+
  geom_col(position="dodge")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom")+
  facet_grid(Medium_id2~m_group, scales="free", space='free_x')

```

## Environmental sites
```{r}
unique(df_finalzz$Site_Category)

kilde <- subset(df_finalzz, Site_Category == c("Tunnel environment", "Artificial grass pitch", "Trafficked road", "Urban park", "Recipient"))
```



1) Waste water treatment
- are thre differences between high and low treatment? water and solids
- are there differences between time points of sampling?

Illustrating differebces between e.g. low and high purification wastewater
- if using average values, need to make sure that the averages are calculated correctly based on grouping

```{r}
df_finalzzzz$Comment_location <- revalue(df_finalzzzz$Comment_location, c("Recipient pond_upper"="Recipient pond"))
df_finalzzzz$Comment_location <- revalue(df_finalzzzz$Comment_location, c("Recipient pond_lower"="Recipient pond"))


```

Calculate mean
- sjekk at ble riktig! ta ut excel f eks

```{r}
#df_long_Y <- df_long_X[!is.na(df_long_X$value),]
#Site_Comment indicate seasonality
#Site_Comment22 indicate conditional differences like high and low purification

#write.csv(df_long_X, "C:/Users/CBG/OneDrive - NIVA/1 #Projects/Screening/Screening_R/Screening/Output/2310054_TEST_barcharts.csv", row.names=FALSE)

envixx1 = df_finalzzzzx %>%
  group_by(Site_Category, compound, Medium_id, Comment_season, Site_name) %>%
  mutate(meanx_season = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx2 = envixx1 %>%
  group_by(Site_Category, compound, Medium_id, Comment_condition) %>%
  mutate(meanx_cond = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx3 = envixx2 %>%
  group_by(Site_Category, compound, Medium_id, Site_name) %>%
  mutate(meanx_name = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx4 = envixx3 %>%
  group_by(Site_Category, compound, Medium_id, Site_Comment) %>%
  mutate(meanx_sc = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx5d = envixx4 %>%
  group_by(Site_Category, compound, Comment_location, Medium_id, Comment_condition) %>%
  mutate(meanx_sc2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx5 = envixx5d %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(meanx = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#for the tunnel we want to separate by Medium_id and by tunnel versus recipient pond
envixx6 <- envixx5 %>%
  mutate(tunnel_site = ifelse(Site_name == "Smestaddammen", "Receiving pond", "Tunnel"))

envixx7 = envixx6 %>%
  group_by(Site_Category, compound, Medium_id2, Comment_location) %>%
  mutate(meanx_tun = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#for road traffick and park, also for wastewater
envixx8 = envixx7 %>%
  group_by(Site_Category, compound, Medium_id, Comment_season) %>%
  mutate(meanx_air = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#tuyre recycling to combine filtered and total water
envixx9 = envixx8 %>%
  group_by(Site_Category, compound, Medium_id2) %>%
  mutate(meanx_tyr = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

#Alns
envixx10 = envixx9 %>%
  group_by(Site_Category, compound, Medium_id, Site_name) %>%
  mutate(meanx_riv = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx11 = envixx10 %>%
  group_by(Site_Category, compound, Medium_id, Site_name, Comment_condition) %>%
  mutate(meanx_ri2v = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx12x = envixx11 %>%
  group_by(Site_Category, compound, Medium_id, Comment_location) %>%
  mutate(meanx_indo = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixx12y = envixx12x %>%
  group_by(Site_Category, compound, Medium_id) %>%
  mutate(meanx_indo2 = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

envixxc = envixx12y %>%
  group_by(Site_Category, compound, Medium_id, Comment_location) %>%
  mutate(meanx_loc = mean(plotting, na.rm = TRUE))%>% 
  ungroup()

```

Below we have the plot in ggplot
```{r}
print(unique(df_finalz$compound))

envixx2x <- envixxc %>% 
  mutate(compound = factor(compound, levels = c("12-PFECA", "13-PFECA", "4,4-ADP", "44-BPS2", "44-PD", "4-HBP", "6PPD", "6PPD-q", "77PD", "7PPD", "ABT",  "Amitriptyline", "BCPS", "BIS TMC", "BOPA", "BP-8", "BPAE", "BPSE", "BTSA","CCl4", "CPPD", "CTC/CTA", "Cyhalothrin", "DBM", "DCM", "DNPD", "DPG", "DPPD", "Fexofenadine", "Fipronil", "Indoxacarb", "IPPD", "isoTAC",  "L6", "L7", "L8", "LCCP", "MBT", "MPAMS", "MTBT",  "MTDID", "NDPD", "OH-BPA", "OHBT", "OP", "PCE", "PhBT", "PPPA", "TAC", "TAI", "TAOT", "TCE", "TCM", "TMBP", "TMMAT", "TMQ")))

#envixx2 <- envixx2x %>% 
#  mutate(Site_name = factor(Site_name, levels = c("Kalbakken", "Brubak", "Breivoll", "Kværner")))

```

1) Artificial grass pitch
- fix order of facets and size of text, grouping of molecules
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx))

envixx4$m_group <- revalue(envixx4$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

print(unique(envixx4$Medium_id))

#set order of facets
envixx4$Medium_id <- factor(envixx4$Medium_id, levels=c("Water, total (ng/L)", "Sludge (ng/g, d.w.)", "Air, particles (ng/m^3)","Granule (ng/g, w.w.)", "Sediment (ng/g, d.w.)", "Dust (ng/g, w.w.)","Water, filtered (ng/L)", "Water, particles (ng/L)", "Biota (ng/g, w.w.)", "Air (ng/m^3)" )) 

#testing grouping below x axis
foot <- ggplot(subset(envixx4, Site_Category%in% c("Artificial grass pitch")), aes(y=meanx, x=compound, fill=Medium_id))+
  geom_col(position="dodge")+
  scale_fill_manual(values=c("dodgerblue3", "dodgerblue3", "dodgerblue3", "#E69F00"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=12, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Medium_id~m_group, scales="free", space='free_x')
 
ggsave("Football.png", foot)


  
```

2) Tunnel environment
- what ends up in the pond?
- difference between filtered and total water?
- differences during the washing?
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_tun))

envixx4$m_group <- revalue(envixx4$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

#the most interesting is what reaches the pond. Figure with discharge and pond

#envixx4x <- subset(envixx4, Medium_id  %in% c("Water (ng/L)", "Water, filtered (ng/L)"))
#envixx4x1 <- subset(envixx4x, Medium_id  %in% c("Sediment (g/g)", "Sludge (g/g)"))
#envixx4x1 <- subset(envixx4x, Medium_id  %in% c("Water (ng/L)"))

envixx4$Comment_location <- revalue(envixx4$Comment_location, c("Sedimentation pool"="Sedimentation basin"))
envixx4x1 <- subset(envixx4, Comment_location  %in% c("Recipient pond", "Sedimentation basin"))

envixx4x2 <- subset(envixx4x1, Medium_id2  %in% c("Solids"))

unique(envixx4x1$Comment_location)

tunn <- ggplot(subset(envixx4x1, Site_Category%in% c("Tunnel environment")), aes(y=meanx_tun, x=compound, fill= Comment_location))+
  geom_col(position="dodge")+
  facet_grid(Comment_location~., scales="free")+
  scale_fill_manual(values=c("dodgerblue3", "#E69F00"))+
  theme_bw()+
    theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  facet_grid(Comment_location~m_group, scales="free", space='free_x')
  


ggsave("Tunnel.png", tunn, width = 7.86, height = 6)
```
3) Trafficked road and urban park
- difference between park and road
- difference between seasons
- difference between weekend and weekday
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_air))

envixx4x2 <- subset(envixx4, Medium_id  %in% c("Air, particles (ng/m^3)"))

#remove duplicate rows before plotting
envixx4x3 <-envixx4x2 %>% 
  distinct(meanx_air, compound, Site_Category, Comment_season, .keep_all = TRUE)

envixx4x3$m_group <- revalue(envixx4x3$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


road <- ggplot(subset(envixx4x3, Site_Category%in% c("Trafficked road", "Urban park")), aes(y=meanx_air, x=compound, fill=Site_Category))+
  geom_col(position = position_dodge2(preserve = "single"))+
  scale_fill_manual(values=c("dodgerblue4", "dodgerblue2"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Comment_season~m_group, scales="free", space='free_x')

ggsave("Road.png", road, width = 7.86, height = 6)

```

4) Wastewater treatment
- only focus on difference between high and low quality treatment
- seasonality ont so interesting, and espesially not with only two observations
To DO: rekkefølge medium, gruppering stoffene, etc. 
```{r differences in wastewater treatment}
#remove nas

envixx4cs <- subset(envixx2x, !is.na(meanx_cond))

envixx4cs$Comment_condition <- factor(envixx4cs$Comment_condition, levels=c("Low", "High" )) 
envixx4cs$Medium_id <- factor(envixx4cs$Medium_id, levels=c("Water, total (ng/L)", "Sludge (ng/g, d.w.)")) 

#pnec_max_miny <- subset(pnec_max_minx, !Medium_id2=="Air")
envixx4css <- subset(envixx4cs, !Medium_id == c("Air (ng/^3)")) 

unique(envixx4$Medium_id)

envixx4css$m_group <- revalue(envixx4css$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


wwater <- ggplot(subset(envixx4css, Site_Category%in% c("Wastewater treatment plant")), aes(y=meanx_cond, x=compound, fill=Comment_condition))+
  geom_col(position="dodge")+
  facet_grid(Medium_id~., scales="free")+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values=c("dodgerblue2", "dodgerblue4"))+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Medium_id~m_group, scales="free", space='free_x')

ggsave("Wwater.png", wwater, width = 7.86, height = 6.8)

```

5) Tyre collection site
- what goes into the environment?
- similar pattern as the rest?
```{r}
envixx4 <- subset(envixx2x, !is.na(meanx_tyr))

#envixx4x2 <- subset(envixx4, !Medium_id  %in% c("Sludge (ng/g)"))
envixx4x3 <- subset(envixx4, Medium_id  %in% c("Water, particles (ng/L)", "Water, filtered (ng/L)", "Dust (ng/g, w.w.)"))

nrow(envixx4x3)
nrow(envixx4)

labx <- c("Air" = "Dust (ng/g)",
          "Water" = "Water (ng/L)")

envixx4x3$m_group <- revalue(envixx4x3$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))


tyre <- ggplot(subset(envixx4x3, Site_Category%in% c("Tyre collection site")), aes(y=meanx_tyr, x=compound))+
  geom_col(position="dodge", fill="dodgerblue3")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=12, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  labs(fill = "Site category")+
facet_grid(Medium_id2~m_group, scales="free", space='free_x', labeller = labeller(Medium_id2 =labx))

ggsave("Tyre.png", tyre, width = 7.86, height = 6.8)
```

6) Urban river Alna
- difference along the river
- difference between low and high flow
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_riv))

envixx4c$Site_name <- revalue(envixx4c$Site_name, c("Apall?kka"="Kalbakken"))
print(unique(envixx4c$Site_name))
 
envixx5c <- envixx4c %>% 
  mutate(Site_name = factor(Site_name, levels = c("Kalbakken", "Brubak", "Breivoll", "Kv‘rner")))

envixx5c$Site_name <- revalue(envixx5c$Site_name, c("Kv‘rner"="Kværner"))
envixx_AlnaS <- subset(envixx5c, Medium_id == "Sediment (ng/g, d.w.)")
envixx_AlnaW <- subset(envixx5c, Medium_id == "Water, total (ng/L)")

Alna <- ggplot(subset(envixx_AlnaW, Site_Category%in% c("Urban river")), aes(y=meanx_riv, x=compound, fill=Site_name))+
  geom_col(position="dodge")+
  facet_grid(Medium_id~Site_name, scales="free_y")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=11, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = "none")+
  scale_fill_manual(values=c("dodgerblue", "dodgerblue3", "dodgerblue4",  "darkblue"))+
  labs(fill = "Site category")+
facet_grid(Site_name~m_group, scales="free_x", space='free_x')

ggsave("Alna.png", Alna,  width= 6.86, height= 7.32)

```

7) Indoor air
- Difference between private and commercial?
- different between the commercial?
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_indo))
envixx4c2 <- subset(envixx2x, !is.na(meanx_indo2))

envixx_IndoA <- subset(envixx4c, Medium_id == "Air (ng/m^3)")
envixx_IndoD <- subset(envixx4c, Medium_id == "Dust (ng/g)")

envixx4c2$m_group <- revalue(envixx4c2$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

air <- ggplot(subset(envixx4c2, Site_Category%in% c("Private home", "Commercial building")), 
       aes(y=meanx_indo2, x=compound, fill=Site_Category))+
  geom_col(position="dodge")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=10, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Site category")+
facet_grid(Medium_id~m_group, scales="free", space='free_x')+
  scale_fill_manual(values=c("dodgerblue2", "dodgerblue4"))


ggsave("Air.png", air, width = 7.86, height = 6.8)

```

7) Biota
```{r}
envixx4c <- subset(envixx2x, !is.na(meanx_sc2))
length(envixx3)

#  facet_grid(Medium_id~Site_Comment, scales="free_y")+
#envixx4x <- subset(envixx4, Medium_id  %in% c("Granule (g/g)"))

envixx5cs <- envixx4c %>% 
  mutate(Comment_condition = factor(Comment_condition, levels = c("Duck mussel", "Perch liver and filet", "Cod liver", "Seagull egg", "Seal blubber")))

envixx5cs$m_group <- revalue(envixx5cs$m_group, c("Long-chain chlorinated paraffins"="LC chlorinated paraffins"))

biota <- ggplot(subset(envixx5cs, Site_Category%in% c("Recipient")), aes(y=meanx_sc2, x=compound, fill=Comment_condition))+
  geom_col(position="dodge")+
   theme_bw()+
  theme(axis.text.x = element_text(angle = 90, size=10, colour="black"),
        axis.text.y = element_text(size=11, colour="black"),
        axis.title.x= element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(angle = 90, hjust=0, size=11, colour="black"),
        strip.text.y = element_text(size=11, colour="black"),
        panel.spacing.x = unit(0, "lines"),
        strip.background.x = element_blank(),
        strip.placement = "bottom",
        legend.position = )+
  labs(fill = "Specie and tissue")+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4", "dodgerblue",  "dodgerblue3", "dodgerblue4"))+
  facet_grid(Comment_location~m_group, scales="free_x", space='free_x')

ggsave("Biota.png", biota, width = 7.86, height = 6.8)
```
















```{r}
library(dplyr)
#is the following correct?
df_filteredX = df_filtered %>%
  group_by(Site_Category, compound) %>%
  summarize(mean = mean(value, na.rm = TRUE),
            nacount = (sum(is.na(value))),
            detect_frac = ((sum(!is.na(value)))/((sum(!is.na(value)))+nacount)*100), 
            .groups="keep")

class(df_filteredX$mean)

```
















```{r making table}
#if(!require(devtools)) install.packages("devtools")
#devtools::install_github("cardiomoon/ztable")
library(ztable)
library(moonBook)

x=table(df_filtered$Dx,acs$smoking)
x

mycolor=gradientColor(low="yellow",mid="orange",high="red",n=6,plot=TRUE)

#subset only those needed
#from long to wide
data_wide <- spread(df_filtered, compound, value)
data_wide2 <-data_wide[,c(2,9, 15:21)]

dfx2 <- na.omit(dfx)

dfx3 <- unlist(dfx)


dfx_wide <-spread(dfx, compound, value)

class(dfx$v)
symm = T
dfx_wide2 <- na.omit(dfx_wide)
ztable(head(dfx_wide2[2:8])) %>% 
    makeHeatmap %>%
    print(caption="Table 6. Heatmap table with user-defined palette")


```















```{r filter}
library(magrittr)

df_long2 <- df_long %>%
  filter(Group="Rubber")%>%
  group_by(Compound)%>%
  filter(Group="Rubber")%>%
  aggregate(d[, 3:4], list(d$Name), mean)


adf %>%
  add_count(x) %>% 
  filter(n %in% tail(sort(unique(n)),2)) %>% 
  arrange(desc(n))

```

```{r}

```

First make summary
First make a table
Then make heatmap colouring https://cran.r-project.org/web/packages/ztable/vignettes/heatmapTable.html
```{r try to make heatmap table}
install.packages("ztable")
library(ztable)

df_long2 <- df_long[,14:15]

x=table(acs$Dx,acs$smoking)

ztable(head(df_long2)) %>% 
    makeHeatmap(palette="YlOrRd",cols=c(14, 15),margin=2) %>%
    print(caption="Table 8. Columnwise heatmap table")
```



```{r Filter out obs detect freq < 30%}
#df_long2 <- df_long[!is.na(df_long$value),] #there should be no NAs
class(df_long2$value)

#Need to deal with the <LODs. For calculating average we use 0.5xLOD, but only when detection frequency is >30%. Per sample type and category.
n_samples  <- n_distinct(df_long_freq$Site_Category, df_long_freq$Medium_id) # total number of samples

df_long_filtered <- df_long_freq %>% 
  group_by(compound, value) %>% 
  filter(!((n_distinct(Site_Category, Medium_id)/n_samples < 0.50)& (value > 0)))%>% 
  ungroup()

#Need some way to filter out the >30% detection frequency, if >30 perform calculation, if below keep 

#Filter those with <LOD

df_long_X <- cbind(df_long_filtered[,c(1:3,9:10, 14, 16:18)], apply(df_long_filtered[,15, drop=F],2, dLimity))
#is.na(df_long_X$value)
#unique(df_long_X$value)
#when converted to numeric the "<LOD" are converted to NAs. Must make sure that these are included in the rate calculations below. They might be which could solve the problem
class(df_long_X$value)
#remove NAs, should not be NAs here, but still missing data from NILU
df_long_Y <- df_long_X[!is.na(df_long_X$value),] 
#nrow(df_long_X)
```



ilter out those molecules with greater than 50% detection frequency in at least two independent sample types/environmental compartments

```{r filter observations in dample type and environment with obs mor}
#https://stackoverflow.com/questions/47536406/filter-based-on-percentage-of-samples-with-an-observation-in-dplyr
#n_samples  <- n_distinct(df_long2$Site_Category, df_long2$Medium_id) # total number of samples
#n_samples

#check if the filtering is performed per compound!!!
#df_filtered <- df_long2 %>% 
#  group_by(compound, value) %>% 
#  filter(!((n_distinct(Site_Category, Medium_id)/n_samples > 0.50)& (value > 0)))

#nrow(df_filtered)

#write.csv(df_filtered, "C:/Users/CBG/OneDrive - NIVA/1 Projects/Screening/Screening_R/Screening/Output/230912_TEST_filtercount.csv", row.names=FALSE)

```

```{r}

```

